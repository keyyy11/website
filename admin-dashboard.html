<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard ‚Äì Aeronas Aerocraft</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="theme-admin">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <div class="admin-sidebar-header">
            <img src="assets/images/Logo-Icon-Only.png" alt="Logo" class="admin-sidebar-logo">
            <h2>Admin</h2>
        </div>
        <nav class="admin-nav">
            <a href="#" class="admin-nav-item active" data-section="dashboard">
                <span class="nav-icon">üìä</span>
                Dashboard
            </a>
            <a href="#" class="admin-nav-item" data-section="news">
                <span class="nav-icon">üì∞</span>
                News
            </a>
            <a href="#" class="admin-nav-item" data-section="applications">
                <span class="nav-icon">üìã</span>
                Job Applications
            </a>
            <a href="#" class="admin-nav-item" data-section="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                Settings
            </a>
        </nav>
        <div class="admin-sidebar-footer">
            <a href="index.html" class="admin-nav-item">
                <span class="nav-icon">üè†</span>
                Back to Site
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <div class="admin-topbar">
            <h1 class="admin-page-title">Dashboard</h1>
            <div class="admin-topbar-actions">
                <span class="admin-user" id="adminUser">Admin</span>
                <button class="admin-btn-small" id="logoutBtn">Logout</button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <section class="admin-section active" id="dashboard">
            <div class="admin-stats-grid">
                <div class="admin-stat-card">
                    <div class="stat-icon">üì∞</div>
                    <div class="stat-content">
                        <h3>News Articles</h3>
                        <div class="stat-number" id="newsCount">0</div>
                        <div class="stat-label">Total articles</div>
                    </div>
                </div>
                <div class="admin-stat-card">
                    <div class="stat-icon">üìã</div>
                    <div class="stat-content">
                        <h3>Job Applications</h3>
                        <div class="stat-number" id="applicationsCount">0</div>
                        <div class="stat-label">Total applications</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- News Section -->
        <section class="admin-section" id="news">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>News Articles</h2>
                    <button class="admin-btn-primary" id="addNewsBtn">Add New Article</button>
                </div>
                <div class="admin-news-grid" id="newsGrid">
                    <!-- News articles will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Applications Section -->
        <section class="admin-section" id="applications">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>Job Applications</h2>
                    <div class="admin-stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 24px;">
                        <div class="admin-stat-card">
                            <div class="stat-icon">üìã</div>
                            <div class="stat-content">
                                <h3>Total Applications</h3>
                                <div class="stat-number" id="totalApplications">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="admin-applications-list" id="applicationsList">
                    <!-- Applications will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section class="admin-section" id="settings">
            <div class="admin-card">
                <h2>Settings</h2>
                <div class="admin-settings-form">
                    <div class="form-group">
                        <label>Site Name</label>
                        <input type="text" class="admin-input" value="Aeronas Aerocraft" id="siteName">
                    </div>
                    <div class="form-group">
                        <label>Contact Email</label>
                        <input type="email" class="admin-input" value="admin@aeronasgrp.com" id="contactEmail">
                    </div>
                    <div class="form-group">
                        <label>Contact Phone</label>
                        <input type="text" class="admin-input" value="07-4450444" id="contactPhone">
                    </div>
                    <button class="admin-btn-primary" id="saveSettingsBtn">Save Settings</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Add News Modal -->
    <div class="admin-modal" id="newsModal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2>Add New Article</h2>
                <button class="admin-modal-close" id="closeModal">&times;</button>
            </div>
            <form class="admin-modal-form" id="newsForm">
                <div class="form-group">
                    <label for="newsTitle">Title</label>
                    <input type="text" id="newsTitle" class="admin-input" required>
                </div>
                <div class="form-group">
                    <label for="newsContent">Content</label>
                    <textarea id="newsContent" class="admin-input" required></textarea>
                </div>
                <div class="form-group">
                    <label for="newsImageUrl">Image URL</label>
                    <input type="url" id="newsImageUrl" class="admin-input" required>
                </div>
                <div class="form-group">
                    <label for="newsDate">Date</label>
                    <input type="date" id="newsDate" class="admin-input" required>
                </div>
                <div class="admin-modal-actions">
                    <button type="button" class="admin-btn-small" id="cancelBtn">Cancel</button>
                    <button type="submit" class="admin-btn-primary">Save Article</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, getDoc, orderBy, query } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase Configuration (inline to avoid module issues)
        const firebaseConfig = {
            apiKey: "AIzaSyBU-ZNBFukfPWsuD2JYwIuHPshVYeSIWew",
            authDomain: "aeronas-aerocraft.firebaseapp.com",
            projectId: "aeronas-aerocraft",
            storageBucket: "aeronas-aerocraft.firebasestorage.app",
            messagingSenderId: "576218545628",
            appId: "1:576218545628:web:6e7483b743b4c2e0336319",
            measurementId: "G-CC8VQY3RCN"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Firebase initialization failed. Please check console for details.');
        }

        // Check authentication
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    console.log('No user authenticated, redirecting to login');
                    window.location.href = 'admin-login.html';
                } else {
                    console.log('User authenticated:', user.email);
                    document.getElementById('adminUser').textContent = user.email;
                    loadNews();
                    loadApplications();
                }
            });
        } else {
            console.error('Auth not initialized, redirecting to login');
            window.location.href = 'admin-login.html';
        }

        // Logout
        if (auth) {
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    window.location.href = 'admin-login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Logout failed: ' + error.message);
                }
            });
        }

        // Navigation
        document.querySelectorAll('.admin-nav-item[data-section]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const section = item.dataset.section;
                
                // Update active nav
                document.querySelectorAll('.admin-nav-item').forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                // Show section
                document.querySelectorAll('.admin-section').forEach(sec => sec.classList.remove('active'));
                document.getElementById(section).classList.add('active');
                
                // Update page title
                document.querySelector('.admin-page-title').textContent = section.charAt(0).toUpperCase() + section.slice(1);
            });
        });

        // Load news articles
        async function loadNews() {
            if (!db) {
                console.error('Firestore not initialized');
                return;
            }
            
            const grid = document.getElementById('newsGrid');
            grid.innerHTML = '';

            try {
                const newsRef = collection(db, 'news');
                const q = query(newsRef, orderBy('date', 'desc'));
                const querySnapshot = await getDocs(q);

                // Update count
                document.getElementById('newsCount').textContent = querySnapshot.size;

                querySnapshot.forEach((docItem) => {
                    const article = docItem.data();
                    const articleCard = document.createElement('div');
                    articleCard.className = 'admin-news-item';
                    articleCard.innerHTML = `
                        <div class="news-item-image" style="background-image: url('${article.imageUrl || ''}')"></div>
                        <div class="news-item-content">
                            <h3>${article.title || 'Untitled'}</h3>
                            <p>${article.content ? article.content.substring(0, 100) + '...' : ''}</p>
                            <div class="news-item-actions">
                                <button class="admin-btn-small delete-news" data-id="${docItem.id}">Delete</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(articleCard);
                });

                // Delete handlers
                document.querySelectorAll('.delete-news').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this article?')) {
                            await deleteDoc(doc(db, 'news', btn.dataset.id));
                            loadNews();
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading news:', error);
            }
        }

        // Modal handlers
        document.getElementById('addNewsBtn').addEventListener('click', () => {
            document.getElementById('newsModal').style.display = 'flex';
            document.getElementById('newsForm').reset();
        });

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('newsModal').style.display = 'none';
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('newsModal').style.display = 'none';
        });

        // Add news form
        document.getElementById('newsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db) {
                alert('Database not initialized. Please refresh the page.');
                return;
            }
            
            const title = document.getElementById('newsTitle').value;
            const content = document.getElementById('newsContent').value;
            const imageUrl = document.getElementById('newsImageUrl').value;
            const date = document.getElementById('newsDate').value;

            try {
                await addDoc(collection(db, 'news'), {
                    title,
                    content,
                    imageUrl,
                    date: new Date(date)
                });
                
                document.getElementById('newsModal').style.display = 'none';
                loadNews();
            } catch (error) {
                console.error('Error adding article:', error);
                alert('Error adding article: ' + error.message);
            }
        });

        // Save settings
        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            alert('Settings saved! (Note: This would save to Firestore in a full implementation)');
        });

        // Load job applications
        async function loadApplications() {
            if (!db) {
                console.error('Firestore not initialized');
                return;
            }
            
            const list = document.getElementById('applicationsList');
            list.innerHTML = '';

            try {
                const applicationsRef = collection(db, 'jobApplications');
                const q = query(applicationsRef, orderBy('submittedAt', 'desc'));
                const querySnapshot = await getDocs(q);

                // Update counts
                const totalCount = querySnapshot.size;
                document.getElementById('totalApplications').textContent = totalCount;
                document.getElementById('applicationsCount').textContent = totalCount;

                if (totalCount === 0) {
                    list.innerHTML = '<p style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No applications yet.</p>';
                    return;
                }

                querySnapshot.forEach((docItem) => {
                    const app = docItem.data();
                    const appCard = document.createElement('div');
                    appCard.className = 'admin-application-item';
                    appCard.innerHTML = `
                        <div class="application-header">
                            <div>
                                <h3>${app.firstName} ${app.lastName}</h3>
                                <p class="application-position">${app.position || 'N/A'}</p>
                            </div>
                            <div class="application-date">
                                ${app.submittedAt ? new Date(app.submittedAt.seconds * 1000).toLocaleDateString() : 'N/A'}
                            </div>
                        </div>
                        <div class="application-details">
                            <div class="detail-row">
                                <span class="detail-label">Email:</span>
                                <span>${app.email || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Phone:</span>
                                <span>${app.phone || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Experience:</span>
                                <span>${app.experience || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Education:</span>
                                <span>${app.education || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="status-badge status-${app.status || 'pending'}">${(app.status || 'pending').toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="application-actions">
                            <button class="admin-btn-small generate-pdf-btn" data-id="${docItem.id}">Generate PDF</button>
                            <button class="admin-btn-small view-details-btn" data-id="${docItem.id}">View Details</button>
                            <button class="admin-btn-small delete-application" data-id="${docItem.id}">Delete</button>
                        </div>
                    `;
                    list.appendChild(appCard);
                });

                // Event handlers
                document.querySelectorAll('.generate-pdf-btn').forEach(btn => {
                    btn.addEventListener('click', () => generatePDF(btn.dataset.id));
                });

                document.querySelectorAll('.view-details-btn').forEach(btn => {
                    btn.addEventListener('click', () => viewApplicationDetails(btn.dataset.id));
                });

                document.querySelectorAll('.delete-application').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this application?')) {
                            await deleteDoc(doc(db, 'jobApplications', btn.dataset.id));
                            loadApplications();
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading applications:', error);
            }
        }

        // Generate PDF for application
        async function generatePDF(applicationId) {
            if (!db) {
                alert('Database not initialized');
                return;
            }

            try {
                const docRef = doc(db, 'jobApplications', applicationId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert('Application not found');
                    return;
                }

                const app = docSnap.data();
                
                // Create PDF content
                const pdfContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Job Application - ${app.firstName} ${app.lastName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 40px; }
                            h1 { color: #333; border-bottom: 2px solid #4fc3f7; padding-bottom: 10px; }
                            .section { margin: 20px 0; }
                            .label { font-weight: bold; color: #666; }
                            .value { margin-left: 10px; }
                            .row { margin: 10px 0; }
                        </style>
                    </head>
                    <body>
                        <h1>Job Application</h1>
                        <div class="section">
                            <h2>Personal Information</h2>
                            <div class="row"><span class="label">Name:</span><span class="value">${app.firstName} ${app.lastName}</span></div>
                            <div class="row"><span class="label">Email:</span><span class="value">${app.email || 'N/A'}</span></div>
                            <div class="row"><span class="label">Phone:</span><span class="value">${app.phone || 'N/A'}</span></div>
                            <div class="row"><span class="label">Address:</span><span class="value">${app.address || 'N/A'}</span></div>
                        </div>
                        <div class="section">
                            <h2>Professional Information</h2>
                            <div class="row"><span class="label">Position:</span><span class="value">${app.position || 'N/A'}</span></div>
                            <div class="row"><span class="label">Experience:</span><span class="value">${app.experience || 'N/A'}</span></div>
                            <div class="row"><span class="label">Education:</span><span class="value">${app.education || 'N/A'}</span></div>
                        </div>
                        <div class="section">
                            <h2>Cover Letter</h2>
                            <p>${app.coverLetter || 'N/A'}</p>
                        </div>
                        <div class="section">
                            <div class="row"><span class="label">Submitted:</span><span class="value">${app.submittedAt ? new Date(app.submittedAt.seconds * 1000).toLocaleString() : 'N/A'}</span></div>
                            <div class="row"><span class="label">Status:</span><span class="value">${(app.status || 'pending').toUpperCase()}</span></div>
                        </div>
                    </body>
                    </html>
                `;

                // Open in new window and print
                const printWindow = window.open('', '_blank');
                printWindow.document.write(pdfContent);
                printWindow.document.close();
                
                // Wait for content to load then print
                printWindow.onload = () => {
                    setTimeout(() => {
                        printWindow.print();
                    }, 250);
                };
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message);
            }
        }

        // View application details
        async function viewApplicationDetails(applicationId) {
            if (!db) {
                alert('Database not initialized');
                return;
            }

            try {
                const docRef = doc(db, 'jobApplications', applicationId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert('Application not found');
                    return;
                }

                const app = docSnap.data();
                const details = `
Application Details:

Name: ${app.firstName} ${app.lastName}
Email: ${app.email || 'N/A'}
Phone: ${app.phone || 'N/A'}
Address: ${app.address || 'N/A'}

Position: ${app.position || 'N/A'}
Experience: ${app.experience || 'N/A'}
Education: ${app.education || 'N/A'}

Cover Letter:
${app.coverLetter || 'N/A'}

Resume: ${app.resumeFileName || 'No file uploaded'}

Submitted: ${app.submittedAt ? new Date(app.submittedAt.seconds * 1000).toLocaleString() : 'N/A'}
Status: ${(app.status || 'pending').toUpperCase()}
                `;
                
                alert(details);
            } catch (error) {
                console.error('Error viewing details:', error);
                alert('Error loading details: ' + error.message);
            }
        }
    </script>
</body>
</html>





