<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard ‚Äì Aeronas Aerocraft</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="theme-admin">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <div class="admin-sidebar-header">
            <img src="assets/images/Logo-Icon-Only.png" alt="Logo" class="admin-sidebar-logo">
            <h2>Admin</h2>
        </div>
        <nav class="admin-nav">
            <a href="#" class="admin-nav-item active" data-section="dashboard">
                <span class="nav-icon">üìä</span>
                Dashboard
            </a>
            <a href="#" class="admin-nav-item" data-section="news">
                <span class="nav-icon">üì∞</span>
                News
            </a>
            <a href="#" class="admin-nav-item" data-section="careers">
                <span class="nav-icon">üíº</span>
                Careers
            </a>
            <!-- <a href="#" class="admin-nav-item" data-section="events">
                <span class="nav-icon">üìÖ</span>
                Events
            </a> -->
            <a href="#" class="admin-nav-item" data-section="applications">
                <span class="nav-icon">üìã</span>
                Job Applications
            </a>
            <a href="#" class="admin-nav-item" data-section="contacts">
                <span class="nav-icon">‚úâÔ∏è</span>
                Contact Messages
            </a>
            <a href="#" class="admin-nav-item" data-section="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                Settings
            </a>
        </nav>
        <div class="admin-sidebar-footer">
            <a href="index.html" class="admin-nav-item">
                <span class="nav-icon">üè†</span>
                Back to Site
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <div class="admin-topbar">
            <h1 class="admin-page-title">Dashboard</h1>
            <div class="admin-topbar-actions">
                <span class="admin-user" id="adminUser">Admin</span>
                <button class="admin-btn-small" id="logoutBtn">Logout</button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <section class="admin-section active" id="dashboard">
            <div class="admin-stats-grid">
                <div class="admin-stat-card" data-navigate="news" style="cursor: pointer;">
                    <div class="stat-icon">üì∞</div>
                    <div class="stat-content">
                        <h3>News Articles</h3>
                        <div class="stat-number" id="newsCount">0</div>
                        <div class="stat-label">Total articles</div>
                    </div>
                </div>
                <div class="admin-stat-card" data-navigate="applications" style="cursor: pointer;">
                    <div class="stat-icon">üìã</div>
                    <div class="stat-content">
                        <h3>Job Applications</h3>
                        <div class="stat-number" id="applicationsCount">0</div>
                        <div class="stat-label">Total applications</div>
                    </div>
                </div>
                <div class="admin-stat-card" data-navigate="contacts" style="cursor: pointer;">
                    <div class="stat-icon">‚úâÔ∏è</div>
                    <div class="stat-content">
                        <h3>Contact Messages</h3>
                        <div class="stat-number" id="contactsCount">0</div>
                        <div class="stat-label">Total messages</div>
                    </div>
                </div>
                <div class="admin-stat-card" data-navigate="careers" style="cursor: pointer;">
                    <div class="stat-icon">üíº</div>
                    <div class="stat-content">
                        <h3>Career Postings</h3>
                        <div class="stat-number" id="careersCount">0</div>
                        <div class="stat-label">Total postings</div>
                    </div>
                </div>
                <!-- <div class="admin-stat-card" data-navigate="events" style="cursor: pointer;">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-content">
                        <h3>Upcoming Events</h3>
                        <div class="stat-number" id="eventsCount">0</div>
                        <div class="stat-label">Total events</div>
                    </div>
                </div> -->
            </div>
        </section>

        <!-- News Section -->
        <section class="admin-section" id="news">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>News Articles</h2>
                    <button class="admin-btn-primary" id="addNewsBtn">Add New Article</button>
                </div>
                <div class="admin-news-grid" id="newsGrid">
                    <!-- News articles will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Careers Section -->
        <section class="admin-section" id="careers">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>Career Postings</h2>
                    <button class="admin-btn-primary" id="addCareerBtn">Add New Career</button>
                </div>
                <div class="admin-news-grid" id="careersGrid">
                    <!-- Career postings will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Events Section - DISABLED -->
        <!-- <section class="admin-section" id="events">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>Upcoming Events</h2>
                    <button class="admin-btn-primary" id="addEventBtn">Add New Event</button>
                </div>
                <div class="admin-news-grid" id="eventsGrid">
                    <!-- Events will be loaded here -->
                </div>
            </div>
        </section> -->

        <!-- Contact Messages Section -->
        <section class="admin-section" id="contacts">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>Contact Messages</h2>
                    <div class="admin-stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 24px;">
                        <div class="admin-stat-card">
                            <div class="stat-icon">‚úâÔ∏è</div>
                            <div class="stat-content">
                                <h3>Total Messages</h3>
                                <div class="stat-number" id="totalContacts">0</div>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="stat-icon">üÜï</div>
                            <div class="stat-content">
                                <h3>New Messages</h3>
                                <div class="stat-number" id="newContacts">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="admin-applications-list" id="contactsList">
                    <!-- Contact messages will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Applications Section -->
        <section class="admin-section" id="applications">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>Job Applications</h2>
                    <div class="admin-stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 24px;">
                        <div class="admin-stat-card">
                            <div class="stat-icon">üìã</div>
                            <div class="stat-content">
                                <h3>Total Applications</h3>
                                <div class="stat-number" id="totalApplications">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="admin-applications-list" id="applicationsList">
                    <!-- Applications will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section class="admin-section" id="settings">
            <div class="admin-card">
                <h2>Settings</h2>
                <div class="admin-settings-form">
                    <div class="form-group">
                        <label>Site Name</label>
                        <input type="text" class="admin-input" value="Aeronas Aerocraft" id="siteName">
                    </div>
                    <div class="form-group">
                        <label>Contact Email</label>
                        <input type="email" class="admin-input" value="admin@aeronasgrp.com" id="contactEmail">
                    </div>
                    <div class="form-group">
                        <label>Contact Phone</label>
                        <input type="text" class="admin-input" value="07-4450444" id="contactPhone">
                    </div>
                    <button class="admin-btn-primary" id="saveSettingsBtn">Save Settings</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Add/Edit News Modal -->
    <div class="admin-modal" id="newsModal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2 id="modalTitle">Add New Article</h2>
                <button class="admin-modal-close" id="closeModal">&times;</button>
            </div>
            <form class="admin-modal-form" id="newsForm">
                <div class="form-group">
                    <label for="newsId">ID (Unique identifier, e.g., "kktm", "utem")</label>
                    <input type="text" id="newsId" class="admin-input" required placeholder="e.g., kktm">
                    <small style="color: rgba(255,255,255,0.6);">This will be used as the document ID in Firestore</small>
                </div>
                <div class="form-group">
                    <label for="newsTitle">Title</label>
                    <input type="text" id="newsTitle" class="admin-input" required placeholder="e.g., AERONAS AEROCRAFT - KKTM">
                </div>
                <div class="form-group">
                    <label for="newsDate">Display Date</label>
                    <input type="text" id="newsDate" class="admin-input" required placeholder="e.g., 23 DECEMBER 2025">
                    <small style="color: rgba(255,255,255,0.6);">Date as it appears on the website</small>
                </div>
                <div class="form-group">
                    <label for="newsDateSort">Sort Date (YYYY-MM-DD)</label>
                    <input type="date" id="newsDateSort" class="admin-input" required>
                    <small style="color: rgba(255,255,255,0.6);">Used for sorting news by date</small>
                </div>
                <div class="form-group">
                    <label for="newsImage">Image Path</label>
                    <input type="text" id="newsImage" class="admin-input" required placeholder="e.g., assets/images/KKTM.jpeg">
                    <small style="color: rgba(255,255,255,0.6);">Path to the image file</small>
                </div>
                <div class="form-group">
                    <label for="newsDescription">Description</label>
                    <textarea id="newsDescription" class="admin-input" required rows="4" placeholder="Description of the news article"></textarea>
                </div>
                <div class="admin-modal-actions">
                    <button type="button" class="admin-btn-small" id="cancelBtn">Cancel</button>
                    <button type="submit" class="admin-btn-primary" id="saveNewsBtn">Save Article</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Career Modal -->
    <div class="admin-modal" id="careerModal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2 id="careerModalTitle">Add New Career</h2>
                <button class="admin-modal-close" id="closeCareerModal">&times;</button>
            </div>
            <form class="admin-modal-form" id="careerForm">
                <div class="form-group">
                    <label for="careerId">ID (Unique identifier, e.g., "mobile-developer")</label>
                    <input type="text" id="careerId" class="admin-input" required placeholder="e.g., mobile-developer">
                    <small style="color: rgba(255,255,255,0.6);">This will be used as the document ID in Firestore</small>
                </div>
                <div class="form-group">
                    <label for="careerTitle">Job Title</label>
                    <input type="text" id="careerTitle" class="admin-input" required placeholder="e.g., Mobile Developer">
                </div>
                <div class="form-group">
                    <label for="careerLocation">Location</label>
                    <input type="text" id="careerLocation" class="admin-input" required placeholder="e.g., Johor Bahru">
                </div>
                <div class="form-group">
                    <label for="careerDescription">Job Description</label>
                    <textarea id="careerDescription" class="admin-input" required rows="4" placeholder="Job description and requirements"></textarea>
                </div>
                <div class="form-group">
                    <label for="careerLink">Link (Optional)</label>
                    <input type="url" id="careerLink" class="admin-input" placeholder="e.g., https://example.com/job-application or job-application.html?position=Mobile Developer">
                    <small style="color: rgba(255,255,255,0.6);">Link to job application form or external job posting (optional)</small>
                </div>
                <div class="admin-modal-actions">
                    <button type="button" class="admin-btn-small" id="cancelCareerBtn">Cancel</button>
                    <button type="submit" class="admin-btn-primary" id="saveCareerBtn">Save Career</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Event Modal - DISABLED -->
    <!-- <div class="admin-modal" id="eventModal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2 id="eventModalTitle">Add New Event</h2>
                <button class="admin-modal-close" id="closeEventModal">&times;</button>
            </div>
            <form class="admin-modal-form" id="eventForm">
                <div class="form-group">
                    <label for="eventId">ID (Unique identifier, e.g., "aerospace-expo-2025")</label>
                    <input type="text" id="eventId" class="admin-input" required placeholder="e.g., aerospace-expo-2025">
                    <small style="color: rgba(255,255,255,0.6);">This will be used as the document ID in Firestore</small>
                </div>
                <div class="form-group">
                    <label for="eventTitle">Event Title</label>
                    <input type="text" id="eventTitle" class="admin-input" required placeholder="e.g., Aerospace Expo 2025">
                </div>
                <div class="form-group">
                    <label for="eventDate">Event Date</label>
                    <input type="date" id="eventDate" class="admin-input" required>
                </div>
                <div class="form-group">
                    <label for="eventDateDisplay">Display Date (Optional)</label>
                    <input type="text" id="eventDateDisplay" class="admin-input" placeholder="e.g., 15 January 2025">
                    <small style="color: rgba(255,255,255,0.6);">Date as it appears on the website (if different from Event Date)</small>
                </div>
                <div class="form-group">
                    <label for="eventLocation">Location</label>
                    <input type="text" id="eventLocation" class="admin-input" required placeholder="e.g., Kuala Lumpur Convention Centre">
                </div>
                <div class="form-group">
                    <label for="eventDescription">Event Description</label>
                    <textarea id="eventDescription" class="admin-input" required rows="4" placeholder="Description of the event"></textarea>
                </div>
                <div class="form-group">
                    <label for="eventImage">Image Path (Optional)</label>
                    <input type="text" id="eventImage" class="admin-input" placeholder="e.g., assets/images/event1.jpg">
                    <small style="color: rgba(255,255,255,0.6);">Path to the event image file</small>
                </div>
                <div class="form-group">
                    <label for="eventLink">Link (Optional)</label>
                    <input type="url" id="eventLink" class="admin-input" placeholder="e.g., https://example.com/event or event-registration.html">
                    <small style="color: rgba(255,255,255,0.6);">Link to event registration or more information</small>
                </div>
                <div class="admin-modal-actions">
                    <button type="button" class="admin-btn-small" id="cancelEventBtn">Cancel</button>
                    <button type="submit" class="admin-btn-primary" id="saveEventBtn">Save Event</button>
                </div>
            </form>
        </div>
    </div> -->

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, getDoc, setDoc, updateDoc, orderBy, query } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase Configuration (inline to avoid module issues)
        const firebaseConfig = {
            apiKey: "AIzaSyBU-ZNBFukfPWsuD2JYwIuHPshVYeSIWew",
            authDomain: "aeronas-aerocraft.firebaseapp.com",
            projectId: "aeronas-aerocraft",
            storageBucket: "aeronas-aerocraft.firebasestorage.app",
            messagingSenderId: "576218545628",
            appId: "1:576218545628:web:6e7483b743b4c2e0336319",
            measurementId: "G-CC8VQY3RCN"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Firebase initialization failed. Please check console for details.');
        }

        // Check authentication
        if (auth) {
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                    console.log('No user authenticated, redirecting to login');
                window.location.href = 'admin-login.html';
            } else {
                    console.log('User authenticated:', user.email);
                document.getElementById('adminUser').textContent = user.email;
                loadNews();
                    loadCareers();
                    // loadEvents(); // DISABLED
                    loadApplications();
                    loadContactMessages();
            }
        });
        } else {
            console.error('Auth not initialized, redirecting to login');
            window.location.href = 'admin-login.html';
        }

        // Logout
        if (auth) {
        document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
            await signOut(auth);
            window.location.href = 'admin-login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Logout failed: ' + error.message);
                }
            });
        }

        // Navigation function
        function navigateToSection(sectionName) {
            // Update active nav
            document.querySelectorAll('.admin-nav-item').forEach(nav => nav.classList.remove('active'));
            const navItem = document.querySelector(`.admin-nav-item[data-section="${sectionName}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
            
            // Show section
            document.querySelectorAll('.admin-section').forEach(sec => sec.classList.remove('active'));
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Update page title
            const pageTitle = document.querySelector('.admin-page-title');
            if (pageTitle) {
                const titleMap = {
                    'dashboard': 'Dashboard',
                    'news': 'News',
                    'careers': 'Careers',
                    // 'events': 'Events', // DISABLED
                    'applications': 'Job Applications',
                    'contacts': 'Contact Messages',
                    'settings': 'Settings'
                };
                pageTitle.textContent = titleMap[sectionName] || sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            }
        }

        // Navigation
        document.querySelectorAll('.admin-nav-item[data-section]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const section = item.dataset.section;
                navigateToSection(section);
            });
        });

        // Stat cards navigation - click on stat card to go to corresponding section
        document.querySelectorAll('.admin-stat-card[data-navigate]').forEach(card => {
            card.addEventListener('click', (e) => {
                const section = card.dataset.navigate;
                if (section) {
                    navigateToSection(section);
                }
            });
            
            // Add hover effect
            card.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'translateY(-2px)';
                card.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
            });
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'translateY(0)';
                card.style.boxShadow = '';
            });
        });

        // Load careers
        async function loadCareers() {
            if (!db) {
                console.error('Firestore not initialized');
                return;
            }
            
            const grid = document.getElementById('careersGrid');
            grid.innerHTML = '<p style="text-align: center; padding: 20px; color: rgba(255,255,255,0.5);">Loading careers...</p>';

            try {
                const careersRef = collection(db, 'careers');
                // Try without orderBy first to avoid index requirement
                let querySnapshot;
                try {
                    const q = query(careersRef, orderBy('title', 'asc'));
                    querySnapshot = await getDocs(q);
                } catch (orderError) {
                    // If orderBy fails (no index or permission), try without ordering
                    console.warn('OrderBy failed, trying without order:', orderError);
                    querySnapshot = await getDocs(careersRef);
                }

                // Update count
                document.getElementById('careersCount').textContent = querySnapshot.size;

                if (querySnapshot.size === 0) {
                    grid.innerHTML = '<p style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No career postings yet. Click "Add New Career" to create one.</p>';
                    return;
                }

                // Sort manually if orderBy failed
                const careers = [];
                querySnapshot.forEach((docItem) => {
                    careers.push({ id: docItem.id, data: docItem.data() });
                });
                
                // Sort by title manually
                careers.sort((a, b) => {
                    const titleA = (a.data.title || '').toLowerCase();
                    const titleB = (b.data.title || '').toLowerCase();
                    return titleA.localeCompare(titleB);
                });

                grid.innerHTML = '';
                careers.forEach(({ id, data: career }) => {
                    const careerCard = document.createElement('div');
                    careerCard.className = 'admin-news-item';
                    const linkDisplay = career.link ? `<p style="margin-top: 8px;"><a href="${career.link}" target="_blank" style="color: #4fc3f7; text-decoration: underline;">üîó View Job Link</a></p>` : '';
                    careerCard.innerHTML = `
                        <div class="news-item-content">
                            <h3>${career.title || 'Untitled'}</h3>
                            <p class="news-item-date">üìç ${career.location || 'No location'}</p>
                            <p>${career.description || 'No description'}</p>
                            ${linkDisplay}
                            <div class="news-item-actions">
                                <button class="admin-btn-small edit-career" data-id="${id}">Edit</button>
                                <button class="admin-btn-small delete-career" data-id="${id}">Delete</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(careerCard);
                });

                // Edit handlers
                document.querySelectorAll('.edit-career').forEach(btn => {
                    btn.addEventListener('click', () => editCareer(btn.dataset.id));
                });

                // Delete handlers
                document.querySelectorAll('.delete-career').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this career posting?')) {
                            try {
                                await deleteDoc(doc(db, 'careers', btn.dataset.id));
                                loadCareers();
                                alert('Career posting deleted successfully!');
                            } catch (error) {
                                console.error('Error deleting career:', error);
                                alert('Error deleting career: ' + error.message);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading careers:', error);
                let errorMessage = 'Error loading careers. ';
                
                if (error.code === 'permission-denied') {
                    errorMessage += 'Please update Firebase security rules for "careers" collection. Check FIREBASE_SETUP_GUIDE.md';
                } else if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Please refresh the page.';
                }
                
                grid.innerHTML = `<p style="text-align: center; padding: 40px; color: #e60505;">${errorMessage}</p>`;
            }
        }

        let editingCareerId = null;

        // Career modal handlers
        document.getElementById('addCareerBtn').addEventListener('click', () => {
            editingCareerId = null;
            document.getElementById('careerModalTitle').textContent = 'Add New Career';
            document.getElementById('saveCareerBtn').textContent = 'Save Career';
            document.getElementById('careerForm').reset();
            document.getElementById('careerId').disabled = false;
            document.getElementById('careerModal').style.display = 'flex';
        });

        document.getElementById('closeCareerModal').addEventListener('click', () => {
            document.getElementById('careerModal').style.display = 'none';
            editingCareerId = null;
        });

        document.getElementById('cancelCareerBtn').addEventListener('click', () => {
            document.getElementById('careerModal').style.display = 'none';
            editingCareerId = null;
        });

        // Close modal when clicking outside
        document.getElementById('careerModal').addEventListener('click', (e) => {
            if (e.target.id === 'careerModal') {
                document.getElementById('careerModal').style.display = 'none';
                editingCareerId = null;
            }
        });
                
        // Edit career function
        async function editCareer(careerId) {
            if (!db) {
                alert('Database not initialized. Please refresh the page.');
                return;
            }

            try {
                const docRef = doc(db, 'careers', careerId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert('Career posting not found');
                    return;
                }

                const career = docSnap.data();
                editingCareerId = careerId;
                
                document.getElementById('careerModalTitle').textContent = 'Edit Career';
                document.getElementById('saveCareerBtn').textContent = 'Update Career';
                document.getElementById('careerId').value = careerId;
                document.getElementById('careerId').disabled = true; // Can't change ID when editing
                document.getElementById('careerTitle').value = career.title || '';
                document.getElementById('careerLocation').value = career.location || '';
                document.getElementById('careerDescription').value = career.description || '';
                document.getElementById('careerLink').value = career.link || '';
                
                document.getElementById('careerModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading career for edit:', error);
                alert('Error loading career: ' + error.message);
            }
        }

        // Add/Update career form
        document.getElementById('careerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db) {
                alert('Database not initialized. Please refresh the page.');
                return;
            }
            
            const careerId = document.getElementById('careerId').value.trim();
            const title = document.getElementById('careerTitle').value.trim();
            const location = document.getElementById('careerLocation').value.trim();
            const description = document.getElementById('careerDescription').value.trim();
            const link = document.getElementById('careerLink').value.trim();

            if (!careerId || !title || !location || !description) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const careerData = {
                    id: careerId,
                    title,
                    location,
                    description,
                    link: link || null, // Store link if provided, null if empty
                    createdAt: editingCareerId ? (await getDoc(doc(db, 'careers', editingCareerId))).data().createdAt : new Date(),
                    updatedAt: new Date()
                };

                if (editingCareerId) {
                    // Update existing career
                    await setDoc(doc(db, 'careers', editingCareerId), careerData, { merge: true });
                    alert('Career posting updated successfully!');
                } else {
                    // Add new career
                    await setDoc(doc(db, 'careers', careerId), careerData);
                    alert('Career posting added successfully!');
                }
                
                document.getElementById('careerModal').style.display = 'none';
                editingCareerId = null;
                loadCareers();
            } catch (error) {
                console.error('Error saving career:', error);
                alert('Error saving career: ' + error.message);
            }
        });

        // Load events - DISABLED
        /* async function loadEvents() {
            if (!db) {
                console.error('Firestore not initialized');
                return;
            }
            
            const grid = document.getElementById('eventsGrid');
            grid.innerHTML = '<p style="text-align: center; padding: 20px; color: rgba(255,255,255,0.5);">Loading events...</p>';

            try {
                const eventsRef = collection(db, 'events');
                // Try with orderBy first, fallback to simple query if index not available
                let querySnapshot;
                try {
                    const q = query(eventsRef, orderBy('date', 'asc'));
                    querySnapshot = await getDocs(q);
                } catch (orderError) {
                    console.warn('OrderBy failed, trying without order:', orderError);
                    querySnapshot = await getDocs(eventsRef);
                }

                // Update count
                document.getElementById('eventsCount').textContent = querySnapshot.size;

                if (querySnapshot.size === 0) {
                    grid.innerHTML = '<p style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No events yet. Click "Add New Event" to create one.</p>';
                    return;
                }

                // Sort manually if orderBy failed
                const events = [];
                querySnapshot.forEach((docItem) => {
                    events.push({ id: docItem.id, data: docItem.data() });
                });
                
                // Sort by date manually
                events.sort((a, b) => {
                    const dateA = a.data.date || '';
                    const dateB = b.data.date || '';
                    return dateA.localeCompare(dateB);
                });

                grid.innerHTML = '';
                events.forEach(({ id, data: event }) => {
                    const eventCard = document.createElement('div');
                    eventCard.className = 'admin-news-item';
                    
                    const eventDate = event.dateDisplay || (event.date ? new Date(event.date).toLocaleDateString() : 'Date TBA');
                    const imageDisplay = event.image ? `<div class="news-item-image" style="background-image: url('${event.image}')"></div>` : '';
                    const linkDisplay = event.link ? `<p style="margin-top: 8px;"><a href="${event.link}" target="_blank" style="color: #4fc3f7; text-decoration: underline;">üîó View Event Link</a></p>` : '';
                    
                    eventCard.innerHTML = `
                        ${imageDisplay}
                        <div class="news-item-content">
                            <h3>${event.title || 'Untitled Event'}</h3>
                            <p class="news-item-date">üìÖ ${eventDate} | üìç ${event.location || 'Location TBA'}</p>
                            <p>${event.description || 'No description'}</p>
                            ${linkDisplay}
                            <div class="news-item-actions">
                                <button class="admin-btn-small edit-event" data-id="${id}">Edit</button>
                                <button class="admin-btn-small delete-event" data-id="${id}">Delete</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(eventCard);
                });

                // Edit handlers
                document.querySelectorAll('.edit-event').forEach(btn => {
                    btn.addEventListener('click', () => editEvent(btn.dataset.id));
                });

                // Delete handlers
                document.querySelectorAll('.delete-event').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this event?')) {
                            try {
                                await deleteDoc(doc(db, 'events', btn.dataset.id));
                                loadEvents();
                                alert('Event deleted successfully!');
                            } catch (error) {
                                console.error('Error deleting event:', error);
                                alert('Error deleting event: ' + error.message);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading events:', error);
                let errorMessage = 'Error loading events. ';
                
                if (error.code === 'permission-denied') {
                    errorMessage += 'Please update Firebase security rules for "events" collection. Check FIREBASE_SETUP_GUIDE.md';
                } else if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Please refresh the page.';
                }
                
                grid.innerHTML = `<p style="text-align: center; padding: 40px; color: #e60505;">${errorMessage}</p>`;
            }
        } */

        // let editingEventId = null; // DISABLED

        // Event modal handlers - DISABLED
        /* document.getElementById('addEventBtn').addEventListener('click', () => {
            editingEventId = null;
            document.getElementById('eventModalTitle').textContent = 'Add New Event';
            document.getElementById('saveEventBtn').textContent = 'Save Event';
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').disabled = false;
            document.getElementById('eventModal').style.display = 'flex';
        });

        document.getElementById('closeEventModal').addEventListener('click', () => {
            document.getElementById('eventModal').style.display = 'none';
            editingEventId = null;
        });

        document.getElementById('cancelEventBtn').addEventListener('click', () => {
            document.getElementById('eventModal').style.display = 'none';
            editingEventId = null;
        });

        // Close modal when clicking outside
        document.getElementById('eventModal').addEventListener('click', (e) => {
            if (e.target.id === 'eventModal') {
                document.getElementById('eventModal').style.display = 'none';
                editingEventId = null;
            }
        });

        // Edit event function
        async function editEvent(eventId) {
            if (!db) {
                alert('Database not initialized. Please refresh the page.');
                return;
            }

            try {
                const docRef = doc(db, 'events', eventId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert('Event not found');
                    return;
                }

                const event = docSnap.data();
                editingEventId = eventId;
                
                document.getElementById('eventModalTitle').textContent = 'Edit Event';
                document.getElementById('saveEventBtn').textContent = 'Update Event';
                document.getElementById('eventId').value = eventId;
                document.getElementById('eventId').disabled = true; // Can't change ID when editing
                document.getElementById('eventTitle').value = event.title || '';
                document.getElementById('eventDate').value = event.date || '';
                document.getElementById('eventDateDisplay').value = event.dateDisplay || '';
                document.getElementById('eventLocation').value = event.location || '';
                document.getElementById('eventDescription').value = event.description || '';
                document.getElementById('eventImage').value = event.image || '';
                document.getElementById('eventLink').value = event.link || '';
                
                document.getElementById('eventModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading event for edit:', error);
                alert('Error loading event: ' + error.message);
            }
        }

        // Add/Update event form
        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db) {
                alert('Database not initialized. Please refresh the page.');
                return;
            }
            
            const eventId = document.getElementById('eventId').value.trim();
            const title = document.getElementById('eventTitle').value.trim();
            const date = document.getElementById('eventDate').value;
            const dateDisplay = document.getElementById('eventDateDisplay').value.trim();
            const location = document.getElementById('eventLocation').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const image = document.getElementById('eventImage').value.trim();
            const link = document.getElementById('eventLink').value.trim();

            if (!eventId || !title || !date || !location || !description) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const eventData = {
                    id: eventId,
                    title,
                    date,
                    dateDisplay: dateDisplay || null,
                    location,
                    description,
                    image: image || null,
                    link: link || null,
                    createdAt: editingEventId ? (await getDoc(doc(db, 'events', editingEventId))).data().createdAt : new Date(),
                    updatedAt: new Date()
                };

                if (editingEventId) {
                    // Update existing event
                    await setDoc(doc(db, 'events', editingEventId), eventData, { merge: true });
                    alert('Event updated successfully!');
                } else {
                    // Add new event
                    await setDoc(doc(db, 'events', eventId), eventData);
                    alert('Event added successfully!');
                }
                
                document.getElementById('eventModal').style.display = 'none';
                editingEventId = null;
                loadEvents();
            } catch (error) {
                console.error('Error saving event:', error);
                alert('Error saving event: ' + error.message);
            }
        }); */

        // Load news articles
        async function loadNews() {
            if (!db) {
                console.error('Firestore not initialized');
                return;
            }
            
            const grid = document.getElementById('newsGrid');
            grid.innerHTML = '';

            try {
                const newsRef = collection(db, 'news');
                const q = query(newsRef, orderBy('dateSort', 'desc'));
                const querySnapshot = await getDocs(q);

                // Update count
                document.getElementById('newsCount').textContent = querySnapshot.size;

                if (querySnapshot.size === 0) {
                    grid.innerHTML = '<p style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No news articles yet. Click "Add New Article" to create one.</p>';
                    return;
                }

                querySnapshot.forEach((docItem) => {
                    const article = docItem.data();
                    const articleCard = document.createElement('div');
                    articleCard.className = 'admin-news-item';
                    articleCard.innerHTML = `
                        <div class="news-item-image" style="background-image: url('${article.image || article.imageUrl || ''}')"></div>
                        <div class="news-item-content">
                            <h3>${article.title || 'Untitled'}</h3>
                            <p class="news-item-date">${article.date || 'No date'}</p>
                            <p>${article.description || (article.content ? article.content.substring(0, 100) + '...' : 'No description')}</p>
                            <div class="news-item-actions">
                                <button class="admin-btn-small edit-news" data-id="${docItem.id}">Edit</button>
                                <button class="admin-btn-small delete-news" data-id="${docItem.id}">Delete</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(articleCard);
                });

                // Edit handlers
                document.querySelectorAll('.edit-news').forEach(btn => {
                    btn.addEventListener('click', () => editNews(btn.dataset.id));
                });

                // Delete handlers
                document.querySelectorAll('.delete-news').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this article?')) {
                            try {
                            await deleteDoc(doc(db, 'news', btn.dataset.id));
                            loadNews();
                                alert('News article deleted successfully!');
                            } catch (error) {
                                console.error('Error deleting news:', error);
                                alert('Error deleting article: ' + error.message);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading news:', error);
                grid.innerHTML = '<p style="text-align: center; padding: 40px; color: #e60505;">Error loading news. Please refresh the page.</p>';
            }
        }

        let editingNewsId = null;

        // Modal handlers
        document.getElementById('addNewsBtn').addEventListener('click', () => {
            editingNewsId = null;
            document.getElementById('modalTitle').textContent = 'Add New Article';
            document.getElementById('saveNewsBtn').textContent = 'Save Article';
            document.getElementById('newsForm').reset();
            document.getElementById('newsId').disabled = false;
            document.getElementById('newsModal').style.display = 'flex';
        });

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('newsModal').style.display = 'none';
            editingNewsId = null;
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('newsModal').style.display = 'none';
            editingNewsId = null;
        });

        // Edit news function
        async function editNews(newsId) {
            if (!db) {
                alert('Database not initialized. Please refresh the page.');
                return;
            }

            try {
                const docRef = doc(db, 'news', newsId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert('News article not found');
                    return;
                }

                const article = docSnap.data();
                editingNewsId = newsId;
                
                document.getElementById('modalTitle').textContent = 'Edit Article';
                document.getElementById('saveNewsBtn').textContent = 'Update Article';
                document.getElementById('newsId').value = newsId;
                document.getElementById('newsId').disabled = true; // Can't change ID when editing
                document.getElementById('newsTitle').value = article.title || '';
                document.getElementById('newsDate').value = article.date || '';
                document.getElementById('newsDateSort').value = article.dateSort || '';
                document.getElementById('newsImage').value = article.image || article.imageUrl || '';
                document.getElementById('newsDescription').value = article.description || article.content || '';
                
                document.getElementById('newsModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading news for edit:', error);
                alert('Error loading article: ' + error.message);
            }
        }

        // Add/Update news form
        document.getElementById('newsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db) {
                alert('Database not initialized. Please refresh the page.');
                return;
            }
            
            const newsId = document.getElementById('newsId').value.trim();
            const title = document.getElementById('newsTitle').value.trim();
            const date = document.getElementById('newsDate').value.trim();
            const dateSort = document.getElementById('newsDateSort').value;
            const image = document.getElementById('newsImage').value.trim();
            const description = document.getElementById('newsDescription').value.trim();

            if (!newsId || !title || !date || !dateSort || !image || !description) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const newsData = {
                    id: newsId,
                    title,
                    date,
                    dateSort,
                    image,
                    description,
                    order: editingNewsId ? (await getDoc(doc(db, 'news', editingNewsId))).data().order || 0 : 0
                };

                if (editingNewsId) {
                    // Update existing news
                    await setDoc(doc(db, 'news', editingNewsId), newsData, { merge: true });
                    alert('News article updated successfully!');
                } else {
                    // Add new news
                    await setDoc(doc(db, 'news', newsId), newsData);
                    alert('News article added successfully!');
                }
                
                document.getElementById('newsModal').style.display = 'none';
                editingNewsId = null;
                loadNews();
            } catch (error) {
                console.error('Error saving article:', error);
                alert('Error saving article: ' + error.message);
            }
        });

        // Save settings
        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            alert('Settings saved! (Note: This would save to Firestore in a full implementation)');
        });

        // Load job applications
        async function loadApplications() {
            if (!db) {
                console.error('Firestore not initialized');
                return;
            }
            
            const list = document.getElementById('applicationsList');
            list.innerHTML = '';

            try {
                const applicationsRef = collection(db, 'jobApplications');
                const q = query(applicationsRef, orderBy('submittedAt', 'desc'));
                const querySnapshot = await getDocs(q);

                // Update counts
                const totalCount = querySnapshot.size;
                document.getElementById('totalApplications').textContent = totalCount;
                document.getElementById('applicationsCount').textContent = totalCount;

                if (totalCount === 0) {
                    list.innerHTML = '<p style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No applications yet.</p>';
                    return;
                }

                querySnapshot.forEach((docItem) => {
                    const app = docItem.data();
                    const appCard = document.createElement('div');
                    appCard.className = 'admin-application-item';
                    appCard.innerHTML = `
                        <div class="application-header">
                            <div>
                                <h3>${app.firstName} ${app.lastName}</h3>
                                <p class="application-position">${app.position || 'N/A'}</p>
                            </div>
                            <div class="application-date">
                                ${app.submittedAt ? new Date(app.submittedAt.seconds * 1000).toLocaleDateString() : 'N/A'}
                            </div>
                        </div>
                        <div class="application-details">
                            <div class="detail-row">
                                <span class="detail-label">Email:</span>
                                <span>${app.email || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Phone:</span>
                                <span>${app.phone || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Experience:</span>
                                <span>${app.experience || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Education:</span>
                                <span>${app.education || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="status-badge status-${app.status || 'pending'}">${(app.status || 'pending').toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="application-actions">
                            <button class="admin-btn-small generate-pdf-btn" data-id="${docItem.id}">Generate PDF</button>
                            <button class="admin-btn-small view-details-btn" data-id="${docItem.id}">View Details</button>
                            <button class="admin-btn-small delete-application" data-id="${docItem.id}">Delete</button>
                        </div>
                    `;
                    list.appendChild(appCard);
                });

                // Event handlers
                document.querySelectorAll('.generate-pdf-btn').forEach(btn => {
                    btn.addEventListener('click', () => generatePDF(btn.dataset.id));
                });

                document.querySelectorAll('.view-details-btn').forEach(btn => {
                    btn.addEventListener('click', () => viewApplicationDetails(btn.dataset.id));
                });

                document.querySelectorAll('.delete-application').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this application?')) {
                            await deleteDoc(doc(db, 'jobApplications', btn.dataset.id));
                            loadApplications();
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading applications:', error);
            }
        }

        // Generate PDF for application
        async function generatePDF(applicationId) {
            if (!db) {
                alert('Database not initialized');
                return;
            }

            try {
                const docRef = doc(db, 'jobApplications', applicationId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert('Application not found');
                    return;
                }

                const app = docSnap.data();
                
                // Create PDF content
                const pdfContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Job Application - ${app.firstName} ${app.lastName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 40px; }
                            h1 { color: #333; border-bottom: 2px solid #4fc3f7; padding-bottom: 10px; }
                            .section { margin: 20px 0; }
                            .label { font-weight: bold; color: #666; }
                            .value { margin-left: 10px; }
                            .row { margin: 10px 0; }
                        </style>
                    </head>
                    <body>
                        <h1>Job Application</h1>
                        <div class="section">
                            <h2>Personal Information</h2>
                            <div class="row"><span class="label">Name:</span><span class="value">${app.firstName} ${app.lastName}</span></div>
                            <div class="row"><span class="label">Email:</span><span class="value">${app.email || 'N/A'}</span></div>
                            <div class="row"><span class="label">Phone:</span><span class="value">${app.phone || 'N/A'}</span></div>
                            <div class="row"><span class="label">Address:</span><span class="value">${app.address || 'N/A'}</span></div>
                        </div>
                        <div class="section">
                            <h2>Professional Information</h2>
                            <div class="row"><span class="label">Position:</span><span class="value">${app.position || 'N/A'}</span></div>
                            <div class="row"><span class="label">Experience:</span><span class="value">${app.experience || 'N/A'}</span></div>
                            <div class="row"><span class="label">Education:</span><span class="value">${app.education || 'N/A'}</span></div>
                        </div>
                        <div class="section">
                            <h2>Cover Letter</h2>
                            <p>${app.coverLetter || 'N/A'}</p>
                        </div>
                        <div class="section">
                            <div class="row"><span class="label">Submitted:</span><span class="value">${app.submittedAt ? new Date(app.submittedAt.seconds * 1000).toLocaleString() : 'N/A'}</span></div>
                            <div class="row"><span class="label">Status:</span><span class="value">${(app.status || 'pending').toUpperCase()}</span></div>
                        </div>
                    </body>
                    </html>
                `;

                // Open in new window and print
                const printWindow = window.open('', '_blank');
                printWindow.document.write(pdfContent);
                printWindow.document.close();
                
                // Wait for content to load then print
                printWindow.onload = () => {
                    setTimeout(() => {
                        printWindow.print();
                    }, 250);
                };
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message);
            }
        }

        // View application details
        async function viewApplicationDetails(applicationId) {
            if (!db) {
                alert('Database not initialized');
                return;
            }

            try {
                const docRef = doc(db, 'jobApplications', applicationId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert('Application not found');
                    return;
                }

                const app = docSnap.data();
                const details = `
Application Details:

Name: ${app.firstName} ${app.lastName}
Email: ${app.email || 'N/A'}
Phone: ${app.phone || 'N/A'}
Address: ${app.address || 'N/A'}

Position: ${app.position || 'N/A'}
Experience: ${app.experience || 'N/A'}
Education: ${app.education || 'N/A'}

Cover Letter:
${app.coverLetter || 'N/A'}

Resume: ${app.resumeFileName || 'No file uploaded'}

Submitted: ${app.submittedAt ? new Date(app.submittedAt.seconds * 1000).toLocaleString() : 'N/A'}
Status: ${(app.status || 'pending').toUpperCase()}
                `;
                
                alert(details);
            } catch (error) {
                console.error('Error viewing details:', error);
                alert('Error loading details: ' + error.message);
            }
        }

        // Load contact messages
        async function loadContactMessages() {
            if (!db) {
                console.error('Firestore not initialized');
                return;
            }
            
            const list = document.getElementById('contactsList');
            list.innerHTML = '';

            try {
                const contactsRef = collection(db, 'contactMessages');
                const q = query(contactsRef, orderBy('submittedAt', 'desc'));
                const querySnapshot = await getDocs(q);

                // Update counts
                const totalCount = querySnapshot.size;
                const newCount = querySnapshot.docs.filter(doc => {
                    const data = doc.data();
                    return !data.read || data.status === 'new';
                }).length;
                
                document.getElementById('totalContacts').textContent = totalCount;
                document.getElementById('contactsCount').textContent = totalCount;
                document.getElementById('newContacts').textContent = newCount;

                if (totalCount === 0) {
                    list.innerHTML = '<p style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No contact messages yet.</p>';
                    return;
                }

                querySnapshot.forEach((docItem) => {
                    const msg = docItem.data();
                    const isRead = msg.read || false;
                    const status = msg.status || 'new';
                    const submittedDate = msg.submittedAt ? new Date(msg.submittedAt.seconds * 1000) : new Date();
                    
                    const msgCard = document.createElement('div');
                    msgCard.className = `admin-application-item ${!isRead ? 'unread-message' : ''}`;
                    msgCard.style.borderLeft = !isRead ? '4px solid #4fc3f7' : '';
                    msgCard.innerHTML = `
                        <div class="application-header">
                            <div>
                                <h3>${msg.name || 'Anonymous'}</h3>
                                <p class="application-position">${msg.subject || 'No subject'}</p>
                            </div>
                            <div class="application-date">
                                ${submittedDate.toLocaleDateString()} ${submittedDate.toLocaleTimeString()}
                            </div>
                        </div>
                        <div class="application-details">
                            <div class="detail-row">
                                <span class="detail-label">Email:</span>
                                <span><a href="mailto:${msg.email || ''}" style="color: #4fc3f7;">${msg.email || 'N/A'}</a></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Message:</span>
                                <span style="max-width: 600px; display: inline-block;">${(msg.message || 'N/A').substring(0, 150)}${(msg.message || '').length > 150 ? '...' : ''}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="status-badge status-${status}">${status.toUpperCase()}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Read:</span>
                                <span>${isRead ? '‚úì Yes' : '‚úó No'}</span>
                            </div>
                        </div>
                        <div class="application-actions">
                            <button class="admin-btn-small view-contact-btn" data-id="${docItem.id}">View Full Message</button>
                            ${!isRead ? `<button class="admin-btn-small mark-read-btn" data-id="${docItem.id}">Mark as Read</button>` : ''}
                            <button class="admin-btn-small update-status-btn" data-id="${docItem.id}">Update Status</button>
                            <button class="admin-btn-small delete-contact" data-id="${docItem.id}">Delete</button>
                        </div>
                    `;
                    list.appendChild(msgCard);
                });

                // Event handlers
                document.querySelectorAll('.view-contact-btn').forEach(btn => {
                    btn.addEventListener('click', () => viewContactDetails(btn.dataset.id));
                });

                document.querySelectorAll('.mark-read-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        await markAsRead(btn.dataset.id);
                    });
                });

                document.querySelectorAll('.update-status-btn').forEach(btn => {
                    btn.addEventListener('click', () => updateContactStatus(btn.dataset.id));
                });

                document.querySelectorAll('.delete-contact').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this message?')) {
                            try {
                                await deleteDoc(doc(db, 'contactMessages', btn.dataset.id));
                                loadContactMessages();
                                alert('Contact message deleted successfully!');
                            } catch (error) {
                                console.error('Error deleting contact:', error);
                                alert('Error deleting message: ' + error.message);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading contact messages:', error);
                list.innerHTML = '<p style="text-align: center; padding: 40px; color: #e60505;">Error loading contact messages. Please refresh the page.</p>';
            }
        }

        // View contact message details
        async function viewContactDetails(contactId) {
            if (!db) {
                alert('Database not initialized');
                return;
            }

            try {
                const docRef = doc(db, 'contactMessages', contactId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert('Contact message not found');
                    return;
                }

                const msg = docSnap.data();
                const submittedDate = msg.submittedAt ? new Date(msg.submittedAt.seconds * 1000) : new Date();
                
                const details = `
Contact Message Details:

Name: ${msg.name || 'N/A'}
Email: ${msg.email || 'N/A'}
Subject: ${msg.subject || 'N/A'}

Message:
${msg.message || 'N/A'}

Submitted: ${submittedDate.toLocaleString()}
Status: ${(msg.status || 'new').toUpperCase()}
Read: ${msg.read ? 'Yes' : 'No'}
                `;
                
                alert(details);
                
                // Mark as read when viewing
                if (!msg.read) {
                    await markAsRead(contactId);
                }
            } catch (error) {
                console.error('Error viewing contact details:', error);
                alert('Error loading details: ' + error.message);
            }
        }

        // Mark contact message as read
        async function markAsRead(contactId) {
            if (!db) {
                alert('Database not initialized');
                return;
            }

            try {
                const docRef = doc(db, 'contactMessages', contactId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert('Contact message not found');
                    return;
                }

                const currentData = docSnap.data();
                const updateData = {
                    read: true
                };
                
                // Update status to 'read' if it's currently 'new'
                if (currentData.status === 'new') {
                    updateData.status = 'read';
                }
                
                await updateDoc(docRef, updateData);
                loadContactMessages();
            } catch (error) {
                console.error('Error marking as read:', error);
                alert('Error updating message: ' + error.message);
            }
        }

        // Update contact message status
        async function updateContactStatus(contactId) {
            if (!db) {
                alert('Database not initialized');
                return;
            }

            try {
                const docRef = doc(db, 'contactMessages', contactId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert('Contact message not found');
                    return;
                }

                const currentStatus = docSnap.data().status || 'new';
                const statuses = ['new', 'read', 'replied', 'archived'];
                const currentIndex = statuses.indexOf(currentStatus);
                const nextIndex = (currentIndex + 1) % statuses.length;
                const newStatus = statuses[nextIndex];

                await updateDoc(docRef, {
                    status: newStatus,
                    read: true
                });
                
                loadContactMessages();
                alert(`Status updated to: ${newStatus.toUpperCase()}`);
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error updating status: ' + error.message);
            }
        }
    </script>
</body>
</html>





