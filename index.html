<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Aeronas Aerocraft</title>
    <link rel="icon" type="image/png" href="assets/images/Logo-Icon-Only.png">
    <link rel="shortcut icon" type="image/png" href="assets/images/Logo-Icon-Only.png">
    <link rel="stylesheet" href="assets/css/style.css">
    <script>
        // Suppress touch event warnings by ensuring passive listeners
        (function() {
            if (typeof EventTarget !== 'undefined') {
                const originalAddEventListener = EventTarget.prototype.addEventListener;
                EventTarget.prototype.addEventListener = function(type, listener, options) {
                    // For touch events, ensure passive is set if not explicitly provided
                    if ((type === 'touchstart' || type === 'touchmove') && !options) {
                        options = { passive: true };
                    } else if ((type === 'touchstart' || type === 'touchmove') && typeof options === 'object' && !('passive' in options)) {
                        options = Object.assign({}, options, { passive: true });
                    }
                    return originalAddEventListener.call(this, type, listener, options);
                };
            }
        })();

        // Suppress console warnings for touch events from external sources
        (function() {
            const originalWarn = console.warn;
            const originalError = console.error;
            
            console.warn = function(...args) {
                const message = args.join(' ');
                // Filter out touch event warnings from external sources
                if (message.includes('non-passive event listener') && 
                    (message.includes('touchmove') || message.includes('touchstart')) &&
                    (message.includes('main.js') || message.includes('init_embed.js'))) {
                    return; // Suppress this warning
                }
                originalWarn.apply(console, args);
            };
            
            console.error = function(...args) {
                const message = args.join(' ');
                // Filter out touch event errors from external sources
                if (message.includes('non-passive event listener') && 
                    (message.includes('touchmove') || message.includes('touchstart')) &&
                    (message.includes('main.js') || message.includes('init_embed.js'))) {
                    return; // Suppress this error
                }
                originalError.apply(console, args);
            };
        })();
    </script>
</head>
<body class="theme-dark">
    <div class="scroll-dark-overlay" id="scrollDarkOverlay"></div>

    <!-- Header -->
    <header class="site-header">
        <div class="header-left">
            <a href="index.html" class="brand-mark">
                <img src="assets/images/Logo-Icon-Only.png" alt="Logo" class="logo">
                <span class="brand-text">Aeronas Aerocraft</span>
            </a>
        </div>

        <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <nav class="header-nav" id="headerNav">
            <div class="mobile-nav-logo">
                <a href="index.html" class="brand-mark">
                    <img src="assets/images/Logo-Icon-Only.png" alt="Logo" class="logo">
                    <span class="brand-text">Aeronas Aerocraft</span>
                </a>
            </div>
            <a href="index.html">Home</a>
            <a href="aircraft.html" class="nav-mobile-aircraft">Aircraft</a>
            <div class="nav-dropdown">
            <a href="aircraft.html">Aircraft</a>
                <div class="dropdown-menu">
                    <a href="aircraft.html#manufacturing">Manufacturing</a>
                    <a href="technology.html">Technology</a>
                    <a href="compliance.html">Compliance</a>
                </div>
            </div>
            <a href="about.html">About</a>
            <a href="services.html">Careers</a>
            <a href="news.html">News</a>
            <!-- <a href="event.html">Event</a> -->
            <a href="contact.html" class="nav-mobile-contact">Contact Us</a>
        </nav>

        <div class="header-right">
            <a href="contact.html" class="nav-cta">Contact Us</a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="home-page">
        <!-- Hero Section -->
        <section class="hero-industrial">
            <div class="hero-inner hero-centered">
                <img src="assets/images/Asset2@2x.png" alt="Aeronas Aerocraft" class="hero-title-image">
                <p class="hero-subtitle hero-subtitle-centered">
                    AERONAS is a full-scale light aircraft manufacturer driving the transformation of Malaysia's aerospace landscape. Backed by proprietary Aircraft Manufacturing Technology (AMT) and an FAA-certified Type Certificate Part 23, AERONAS is positioned as a game changer and catalyst for the regional and global aviation industry.
                </p>
                <div class="hero-actions">
                    <a href="#video-section" class="primary-cta" id="getStartedBtn">Get started</a>
                </div>
                <p class="hero-caption">Trusted by operators and partners across the region.</p>
            </div>
        </section>

        <!-- Social Media Icons Section -->
        <section class="social-icons-section" id="socialIconsSection">
            <div class="social-icons-grid">
                <div class="social-icon-item">
                    <div class="icon-box icon-first-malaysia"></div>
                    <p>FIRST IN MALAYSIA</p>
                </div>
                <div class="social-icon-item">
                    <div class="icon-box icon-engineering"></div>
                    <p>ENGINEERING</p>
                </div>
                <div class="social-icon-item">
                    <div class="icon-box icon-certification-safety"></div>
                    <p>CERTIFICATION & SAFETY</p>
                </div>
                <div class="social-icon-item">
                    <div class="icon-box icon-manufacturing"></div>
                    <p>MANUFACTURING</p>
                </div>
                <div class="social-icon-item">
                    <div class="icon-box icon-performance"></div>
                    <p>PERFORMANCE</p>
                </div>
                <div class="social-icon-item">
                    <div class="icon-box icon-reliability"></div>
                    <p>RELIABILITY</p>
                </div>
            </div>
            <div class="social-icons-text">
                <div class="home-manufacture-image" aria-hidden="true">
                    <img src="assets/images/100.jpeg" alt="Aeronas aircraft manufacturing">
                </div>
                <h2>Malaysia's First Aircraft Manufacturer</h2>
                <p>Aeronas Aerocraft is Malaysia‚Äôs first small aircraft manufacturer, executing a focused strategy to build a globally competitive aerospace company engineered to international certification, performance, and safety standards. We operate with industrial discipline across advanced aeronautical engineering, R&amp;D, and manufacturing, moving fast, making data-driven decisions, and challenging legacy aerospace models. Our objective is clear: deliver efficient, reliable, and commercially scalable aircraft while establishing national aerospace capability that competes on a global level.</p>
            </div>
        </section>

        <!-- Design Mockups Grid (News Section) -->
        <section class="mockups-section">
            <div class="news-video-container" id="video-section">
                <div class="video-top-line" id="videoTopLine"></div>
                <video id="newsVideo" autoplay loop playsinline muted class="news-video" controlsList="nodownload nofullscreen noremoteplayback" disablePictureInPicture preload="auto">
                    <source src="assets/images/newvideomp4.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div class="video-dark-overlay" id="videoDarkOverlay"></div>
                <div class="video-controls">
                    <button type="button" class="video-control-btn" id="playPauseBtn" aria-label="Play/Pause">
                        <span class="play-icon">‚ñ∂Ô∏è</span>
                        <span class="pause-icon" style="display: none;">‚è∏Ô∏è</span>
                    </button>
                    <button type="button" class="video-control-btn" id="soundBtn" aria-label="Toggle sound">
                        <span class="mute-icon">üîá</span>
                        <span class="unmute-icon" style="display: none;">üîä</span>
                    </button>
                        </div>
                    </div>

            <!-- Our Story + Engineering Section (below video) -->
            <div class="home-story-section">
                <div class="home-story-row top-row">
                    <div class="home-story-merged-card">
                        <a href="heritage.html" class="home-story-card our-story-card" style="text-decoration: none; display: block;">
                            <div class="home-story-overlay">
                                <h3>OUR STORY</h3>
                                <p>
                                    We have come a long way from humble beginnings to becoming the selected few that have Part 23 Type Certificate ownership.
                                    The struggles and sacrifice is for the "Rakyat" and the country. The ambition of our Principle is the spark to building
                                    the Nation's aerospace industry.
                                </p>
                    </div>
                </a>
                        <div class="home-story-card story-gallery-card" id="storyGalleryCard">
                            <div class="story-gallery-slides">
                                <div class="story-gallery-slide active" style="background-image: url('assets/images/200jpeg.jpeg');"></div>
                                <div class="story-gallery-slide" style="background-image: url('assets/images/200jpeg.jpeg');"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="home-story-row bottom-row">
                    <div class="home-story-merged-card">
                        <a href="#" class="home-story-card built-on-engineering-card" style="text-decoration: none; display: block;">
                            <div class="home-story-overlay">
                                <h3>BUILT ON ENGINEERING.<br>DRIVEN BY STANDARDS.</h3>
                                <p>
                                    Aeronas Aerocraft is a Malaysian light aircraft manufacturer committed to developing reliable, compliant, and future-ready aviation solutions.
                                    Our focus is not rapid market entry, but disciplined engineering, regulatory alignment, and long-term manufacturing capability‚Äîensuring every aircraft meets the expectations of professional operators and institutional stakeholders.
                                </p>
                            </div>
                        </a>
                        <div class="home-story-card story-gallery-card-bottom" id="storyGalleryCardBottom">
                            <div class="story-gallery-slides">
                                <div class="story-gallery-slide active" style="background-image: url('assets/images/engine.jpeg');"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mockups-grid" id="newsCardsGrid">
                <!-- News cards will be dynamically loaded here -->
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <!-- Left Section: Branding & Social Media -->
            <div class="footer-col footer-brand">
                <div class="footer-logo">
                    <img src="assets/images/Logo-Icon-Only.png" alt="Logo" class="footer-logo-img">
                    <span class="footer-brand-text">Aeronas Aerocraft</span>
                </div>
                <p class="footer-description">Leading aerospace innovation and excellence in aircraft manufacturing, technology, and compliance solutions.</p>
                <div class="footer-social">
                    <a href="https://www.linkedin.com/in/aeronas-aerocraft-341b8939b" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="LinkedIn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                        </svg>
                    </a>
                    <a href="https://www.instagram.com/aeronasaerocraft" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Instagram">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Middle Section: Quick Links -->
            <div class="footer-col footer-links">
                <h4>Quick Links</h4>
                <ul class="footer-nav">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="aircraft.html">Aircraft</a></li>
                    <li><a href="services.html">Careers</a></li>
                    <li><a href="news.html">News</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </div>

            <!-- Right Section: Contact Info -->
            <div class="footer-col footer-contact-info">
                <h4>Get In Touch</h4>
                <ul class="footer-contact-list">
                    <li>
                        <div class="contact-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                        </div>
                        <span>Malaysia</span>
                    </li>
                    <li>
                        <div class="contact-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                            </svg>
                        </div>
                        <a href="tel:074450444">07-4450444</a>
                    </li>
                    <li>
                        <div class="contact-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                            </svg>
                        </div>
                        <a href="mailto:admin@aeronasgrp.com">admin@aeronasgrp.com</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>¬© 2025 Aeronas Aerocraft. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        // Import Firebase functions
        import { loadNewsFromFirestore } from './assets/js/news-firebase.js';
        import { newsData } from './assets/js/news-data.js';
        
        // Helper function to format news title for display
        function formatNewsTitle(title, maxLength = 50) {
            if (!title) return 'NEWS';
            // Escape HTML
            const safeTitle = title.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            // Convert to uppercase and truncate if needed
            let formatted = safeTitle.toUpperCase();
            if (formatted.length > maxLength) {
                formatted = formatted.substring(0, maxLength) + '...';
            }
            // Replace newlines with <br>
            formatted = formatted.replace(/\n/g, '<br>');
            return formatted;
        }

        // News card templates
        const cardTemplates = [
            {
                type: 'latest-news',
                html: (news) => {
                    const title = formatNewsTitle(news.title || 'LATEST NEWS', 40);
                    return `
                    <a href="news.html?news=${news.id}" class="mockup-card card-latest-news" data-news-id="${news.id}">
                        <div class="mockup-sidebar red-sidebar">
                            <p class="sidebar-text vertical">AERONAS.COM</p>
                            <p class="sidebar-text-bottom">NEWS</p>
                        </div>
                        <div class="mockup-content">
                            <div class="mockup-overlay">
                                <h3>${title}</h3>
                                <div class="mockup-brand">
                                    <span class="brand-aeronas">AERONAS</span>
                                    <span class="brand-aerocraft">AEROCRAFT</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `;
                }
            },
            {
                type: 'news-updates',
                html: (news) => {
                    const title = formatNewsTitle(news.title || 'NEWS UPDATES EVENTS', 40);
                    // Split long titles into multiple lines
                    const titleParts = title.split(' ');
                    let titleHtml = '';
                    if (titleParts.length <= 3) {
                        titleHtml = title;
                    } else {
                        // Split into chunks for better display
                        const chunk1 = titleParts.slice(0, Math.ceil(titleParts.length / 3)).join(' ');
                        const chunk2 = titleParts.slice(Math.ceil(titleParts.length / 3), Math.ceil(titleParts.length * 2 / 3)).join(' ');
                        const chunk3 = titleParts.slice(Math.ceil(titleParts.length * 2 / 3)).join(' ');
                        titleHtml = `${chunk1}<br>${chunk2}<br>${chunk3}`;
                    }
                    return `
                    <a href="news.html?news=${news.id}" class="mockup-card card-news-updates" data-news-id="${news.id}">
                        <div class="mockup-overlay-full">
                            <h3>${titleHtml}</h3>
                            <div class="mockup-brand">
                                <span class="brand-aeronas">AERONAS</span>
                                <span class="brand-aerocraft">AEROCRAFT</span>
                            </div>
                        </div>
                    </a>
                `;
                }
            },
            {
                type: 'industry-news',
                html: (news) => {
                    const title = formatNewsTitle(news.title || 'INDUSTRY NEWS', 35);
                    // Split into two lines if long
                    const titleParts = title.split(' ');
                    let titleHtml = '';
                    if (titleParts.length <= 4) {
                        titleHtml = title;
                    } else {
                        const midPoint = Math.ceil(titleParts.length / 2);
                        titleHtml = `${titleParts.slice(0, midPoint).join(' ')}<br>${titleParts.slice(midPoint).join(' ')}`;
                    }
                    return `
                    <a href="news.html?news=${news.id}" class="mockup-card card-industry-news" data-news-id="${news.id}">
                        <div class="mockup-sidebar blue-sidebar">
                            <p class="sidebar-text vertical">AERONAS.COM</p>
                            <p class="sidebar-text-bottom">NEWS</p>
                        </div>
                        <div class="mockup-content">
                            <div class="mockup-overlay">
                                <h3>${titleHtml}</h3>
                                <div class="mockup-brand">
                                    <span class="brand-aeronas">AERONAS</span>
                                    <span class="brand-aerocraft">AEROCRAFT</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `;
                }
            },
            {
                type: 'aerospace-news',
                html: (news) => {
                    const title = formatNewsTitle(news.title || 'AEROSPACE NEWS', 30);
                    return `
                    <a href="news.html?news=${news.id}" class="mockup-card card-aerospace-news" data-news-id="${news.id}">
                        <div class="mockup-overlay-full">
                            <h3>${title}</h3>
                            <div class="mockup-brand">
                                <span class="brand-aerocraft">AEROCRAFT</span>
                            </div>
                        </div>
                    </a>
                `;
                }
            },
            {
                type: 'news-ac',
                html: (news) => {
                    // text-right menggunakan tajuk news yang sebenar - panjangkan tanpa truncate
                    const title = formatNewsTitle(news.title || 'UPDATES', 200); // Increase max length
                    // Jangan truncate - biar ayat memajang
                    return `
                    <a href="news.html?news=${news.id}" class="mockup-card card-news-ac" data-news-id="${news.id}">
                        <div class="mockup-overlay-split">
                            <span class="text-right">${title}</span>
                            <span class="text-ac">AC</span>
                        </div>
                    </a>
                `;
                }
            },
            {
                type: 'latest-split',
                html: (news) => {
                    const title = formatNewsTitle(news.title || 'LATEST NEWS', 40);
                    const titleParts = title.split(' ').filter(p => p.length > 0);
                    let firstLine = 'LATEST NEWS';
                    let secondLine = 'STAY UPDATED';
                    if (titleParts.length > 0) {
                        const midPoint = Math.ceil(titleParts.length / 2);
                        firstLine = titleParts.slice(0, midPoint).join(' ') || 'LATEST NEWS';
                        secondLine = titleParts.slice(midPoint).join(' ') || 'STAY UPDATED';
                    }
                    return `
                    <a href="news.html?news=${news.id}" class="mockup-card card-latest-split" data-news-id="${news.id}">
                        <div class="mockup-split-top"></div>
                        <div class="mockup-split-bottom">
                            <div class="split-left-red">
                                <h3>${firstLine}<br>${secondLine}</h3>
                                <p>AERONAS.COM</p>
                            </div>
                            <div class="split-right-blue">
                                <h3>NEWS</h3>
                            </div>
                        </div>
                    </a>
                `;
                }
            }
        ];
        
        // Function to render news cards with images
        function renderNewsCards(newsArray) {
            const grid = document.getElementById('newsCardsGrid');
            if (!grid) return;
            
            // Sort by date (newest first)
            const sortedNews = [...newsArray].sort((a, b) => {
                return new Date(b.dateSort) - new Date(a.dateSort);
            });
            
            // Clear grid
            grid.innerHTML = '';
            
            // Render cards (max 5 cards)
            const newsToShow = sortedNews.slice(0, 5);
            
            // Create style element for dynamic background images
            let styleElement = document.getElementById('dynamic-news-images');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'dynamic-news-images';
                document.head.appendChild(styleElement);
            }
            
            let styleContent = '';
            
            newsToShow.forEach((news, index) => {
                // Normalize news.id to lowercase for consistent mapping
                const normalizedId = (news.id || '').toLowerCase().trim();
                
                // Map news ID to correct image path FIRST (before any processing) - ALWAYS OVERRIDE Firebase/deleted images
                const newsImageMap = {
                    'kktm': 'assets/images/KKTM.jpeg',
                    'utem': 'assets/images/UTEM.jpeg',
                    'usim': 'assets/images/USIM.jpeg',
                    'uthm': 'assets/images/UTHM.jpeg',
                    'gmi': 'assets/images/GMI.jpeg',
                    'chemtron': 'assets/images/CHEMTRON.jpeg',
                    'happy-new-year': 'assets/images/firework.jpeg',
                    'happynewyear': 'assets/images/firework.jpeg',
                    'firework': 'assets/images/firework.jpeg'
                };
                
                // Auto-detect image based on title if ID not found
                let imagePath = '';
                const titleLower = (news.title || '').toLowerCase();
                
                // Check by normalized ID first
                if (newsImageMap[normalizedId]) {
                    imagePath = newsImageMap[normalizedId];
                    news.image = imagePath;
                    news.imageUrl = imagePath;
                    console.log(`Index - News ${news.id} (${news.title}): FORCE override Firebase/deleted image with correct local image: ${imagePath}`);
                } else if (titleLower.includes('kktm')) {
                    // Auto-detect KKTM by title
                    imagePath = 'assets/images/KKTM.jpeg';
                    news.image = imagePath;
                    news.imageUrl = imagePath;
                    newsImageMap[normalizedId] = imagePath;
                    console.log(`Index - News ${news.id} (${news.title}): Auto-detected KKTM, using KKTM.jpeg`);
                } else if (titleLower.includes('utem')) {
                    // Auto-detect UTeM by title
                    imagePath = 'assets/images/UTEM.jpeg';
                    news.image = imagePath;
                    news.imageUrl = imagePath;
                    newsImageMap[normalizedId] = imagePath;
                    console.log(`Index - News ${news.id} (${news.title}): Auto-detected UTeM, using UTEM.jpeg`);
                } else if (titleLower.includes('usim')) {
                    // Auto-detect USIM by title
                    imagePath = 'assets/images/USIM.jpeg';
                    news.image = imagePath;
                    news.imageUrl = imagePath;
                    newsImageMap[normalizedId] = imagePath;
                    console.log(`Index - News ${news.id} (${news.title}): Auto-detected USIM, using USIM.jpeg`);
                } else if (titleLower.includes('uthm')) {
                    // Auto-detect UTHM by title
                    imagePath = 'assets/images/UTHM.jpeg';
                    news.image = imagePath;
                    news.imageUrl = imagePath;
                    newsImageMap[normalizedId] = imagePath;
                    console.log(`Index - News ${news.id} (${news.title}): Auto-detected UTHM, using UTHM.jpeg`);
                } else if (titleLower.includes('gmi')) {
                    // Auto-detect GMI by title
                    imagePath = 'assets/images/GMI.jpeg';
                    news.image = imagePath;
                    news.imageUrl = imagePath;
                    newsImageMap[normalizedId] = imagePath;
                    console.log(`Index - News ${news.id} (${news.title}): Auto-detected GMI, using GMI.jpeg`);
                } else if (titleLower.includes('chemtron')) {
                    // Auto-detect CHEMTRON by title
                    imagePath = 'assets/images/CHEMTRON.jpeg';
                    news.image = imagePath;
                    news.imageUrl = imagePath;
                    newsImageMap[normalizedId] = imagePath;
                    console.log(`Index - News ${news.id} (${news.title}): Auto-detected CHEMTRON, using CHEMTRON.jpeg`);
                } else if (titleLower.includes('happy new year') || titleLower.includes('firework')) {
                    // Auto-detect HAPPY NEW YEAR by title
                    imagePath = 'assets/images/firework.jpeg';
                    news.image = imagePath;
                    news.imageUrl = imagePath;
                    newsImageMap[normalizedId] = imagePath;
                    console.log(`Index - News ${news.id} (${news.title}): Auto-detected HAPPY NEW YEAR, using firework.jpeg`);
                } else {
                    // Fallback to Firebase image if no mapping (shouldn't happen)
                    imagePath = news.image || news.imageUrl || '';
                    console.warn(`Index - News ${news.id} (${news.title}): No image mapping found, using Firebase image: ${imagePath}`);
                }
                
                // Force GMI to use correct image at the start (before any processing)
                if (news.id === 'gmi' || news.title?.toLowerCase().includes('gmi') || news.title?.toUpperCase().includes('GMI')) {
                    imagePath = 'assets/images/GMI.jpeg';
                    console.log(`Index - News ${news.id} (${news.title}): Force GMI image to assets/images/GMI.jpeg at start`);
                }
                
                // Map filename to correct image file (always use lowercase extension)
                const imageMap = {
                    'UTeM-Aeronas.jpeg': 'UTEM.jpeg',
                    'UTeM-Aeronas.Jpeg': 'UTEM.jpeg',
                    'UTeM-Aeronas.JPEG': 'UTEM.jpeg',
                    'UTeM-Aeronas': 'UTEM.jpeg',
                    'UTEM.jpeg': 'UTEM.jpeg',
                    'UTEM.Jpeg': 'UTEM.jpeg',
                    'UTEM.JPEG': 'UTEM.jpeg',
                    'KKTM.jpeg': 'KKTM.jpeg',
                    'KKTM.Jpeg': 'KKTM.jpeg',
                    'USIM.jpeg': 'USIM.jpeg',
                    'USIM.Jpeg': 'USIM.jpeg',
                    'UTHM.jpeg': 'UTHM.jpeg',
                    'UTHM.Jpeg': 'UTHM.jpeg',
                    'GMI.jpeg': 'GMI.jpeg',
                    'GMI.Jpeg': 'GMI.jpeg',
                    'CHEMTRON.jpeg': 'CHEMTRON.jpeg',
                    'CHEMTRON.Jpeg': 'CHEMTRON.jpeg'
                };
                
                // Extract filename from path (handle both absolute and relative paths)
                let filename = '';
                if (imagePath.includes('C:\\') || imagePath.includes('C:/') || imagePath.includes('\\')) {
                    // Absolute Windows path
                    filename = imagePath.split(/[/\\]/).pop();
                } else if (imagePath.includes('/')) {
                    // Relative path with directory
                    filename = imagePath.split('/').pop();
                } else {
                    // Just filename
                    filename = imagePath;
                }
                
                // Normalize extension to lowercase for case-insensitive matching
                const filenameLower = filename.toLowerCase();
                const baseName = filename.split('.').slice(0, -1).join('.');
                const extension = filename.split('.').pop()?.toLowerCase() || '';
                const normalizedFilename = extension ? `${baseName}.${extension}` : filename;
                
                // Apply mapping to get correct filename (case-insensitive)
                let correctFilename = imageMap[filename] || imageMap[normalizedFilename] || imageMap[filenameLower];
                if (!correctFilename) {
                    // If no mapping found, use normalized filename (lowercase extension)
                    correctFilename = normalizedFilename;
                }
                
                // Rebuild path with correct filename
                if (imagePath.includes('C:\\') || imagePath.includes('C:/') || imagePath.includes('\\')) {
                    // Absolute path - convert to relative
                    imagePath = `assets/images/${correctFilename}`;
                    if (filename !== correctFilename) {
                        console.log(`Index - News ${news.id}: Converted "${filename}" to "${correctFilename}"`);
                    }
                } else if (imagePath.includes('/')) {
                    // Relative path - replace filename
                    imagePath = imagePath.replace(filename, correctFilename);
                    if (filename !== correctFilename) {
                        console.log(`Index - News ${news.id}: Fixed "${filename}" to "${correctFilename}"`);
                    }
                } else {
                    // Just filename - add path prefix
                    imagePath = `assets/images/${correctFilename}`;
                    if (filename !== correctFilename) {
                        console.log(`Index - News ${news.id}: Fixed "${filename}" to "${correctFilename}"`);
                    }
                }
                
                // Final replacement for any remaining UTeM-Aeronas references (safety check)
                if (imagePath && imagePath.includes('UTeM-Aeronas')) {
                    imagePath = imagePath.replace(/UTeM-Aeronas\.jpeg?/g, 'UTEM.jpeg');
                    console.log(`Index - News ${news.id}: Final safety fix - replaced UTeM-Aeronas with UTEM`);
                }
                
                // Remove URL encoding and clean path
                imagePath = imagePath.replace(/%22/g, '').replace(/%20/g, ' ').replace(/['"]/g, '').trim();
                
                // Ensure path is relative (final check)
                if (imagePath && !imagePath.startsWith('assets/') && !imagePath.startsWith('/assets/') && !imagePath.startsWith('./assets/') && !imagePath.startsWith('http')) {
                    const finalFilename = imagePath.split(/[/\\]/).pop();
                    const finalCorrectFilename = imageMap[finalFilename] || finalFilename;
                    imagePath = `assets/images/${finalCorrectFilename}`;
                }
                
                // Final validation - ensure no encoding issues
                if (imagePath.includes('%')) {
                    imagePath = decodeURIComponent(imagePath);
                    console.log(`Index - News ${news.id}: Decoded URL encoding in path`);
                }
                
                // Final normalization - ensure extension is lowercase
                if (imagePath && imagePath.includes('.')) {
                    const pathParts = imagePath.split('.');
                    if (pathParts.length > 1) {
                        const ext = pathParts.pop();
                        imagePath = pathParts.join('.') + '.' + ext.toLowerCase();
                    }
                }
                
                // Final force GMI check (after all processing, before template assignment)
                if (news.id === 'gmi' || news.title?.toLowerCase().includes('gmi') || news.title?.toUpperCase().includes('GMI')) {
                    imagePath = 'assets/images/GMI.jpeg';
                    console.log(`Index - News ${news.id} (${news.title}): Final force GMI image path AFTER all processing: ${imagePath}`);
                }
                
                // FINAL OVERRIDE: Always use correct image based on news.id (for ALL news, not just GMI)
                const finalImageMap = {
                    'kktm': 'assets/images/KKTM.jpeg',
                    'utem': 'assets/images/UTEM.jpeg',
                    'usim': 'assets/images/USIM.jpeg',
                    'uthm': 'assets/images/UTHM.jpeg',
                    'gmi': 'assets/images/GMI.jpeg',
                    'chemtron': 'assets/images/CHEMTRON.jpeg'
                };
                
                if (finalImageMap[news.id]) {
                    imagePath = finalImageMap[news.id];
                    console.log(`Index - News ${news.id} (${news.title}): FINAL OVERRIDE - Using correct image: ${imagePath}`);
                }
                
                const template = cardTemplates[index % cardTemplates.length];
                const cardHtml = template.html(news);
                grid.insertAdjacentHTML('beforeend', cardHtml);
                
                // Debug: Log card assignment (especially for card #6)
                if (index === 5) {
                    console.log(`Index - Card #6 (index 5): news.id=${news.id}, news.title=${news.title}, template.type=${template.type}, imagePath=${imagePath}`);
                }
                
                // Set background image for the card
                const card = grid.querySelector(`[data-news-id="${news.id}"]`);
                if (card) {
                    // Force correct image based on news ID (FIRST thing in card processing)
                    const normalizedId = (news.id || '').toLowerCase().trim();
                    const titleLower = (news.title || '').toLowerCase();
                    const cardNewsImageMap = {
                        'kktm': 'assets/images/KKTM.jpeg',
                        'utem': 'assets/images/UTEM.jpeg',
                        'usim': 'assets/images/USIM.jpeg',
                        'uthm': 'assets/images/UTHM.jpeg',
                        'gmi': 'assets/images/GMI.jpeg',
                        'chemtron': 'assets/images/CHEMTRON.jpeg',
                        'happy-new-year': 'assets/images/firework.jpeg',
                        'happynewyear': 'assets/images/firework.jpeg',
                        'firework': 'assets/images/firework.jpeg'
                    };
                    
                    // Check by normalized ID first
                    if (cardNewsImageMap[normalizedId]) {
                        imagePath = cardNewsImageMap[normalizedId];
                        console.log(`Index - News ${news.id}: Force mapped image in card processing: ${imagePath}`);
                    } else {
                        // Auto-detect by title
                        if (titleLower.includes('kktm')) {
                            imagePath = 'assets/images/KKTM.jpeg';
                        } else if (titleLower.includes('utem')) {
                            imagePath = 'assets/images/UTEM.jpeg';
                        } else if (titleLower.includes('usim')) {
                            imagePath = 'assets/images/USIM.jpeg';
                        } else if (titleLower.includes('uthm')) {
                            imagePath = 'assets/images/UTHM.jpeg';
                        } else if (titleLower.includes('gmi')) {
                            imagePath = 'assets/images/GMI.jpeg';
                        } else if (titleLower.includes('chemtron')) {
                            imagePath = 'assets/images/CHEMTRON.jpeg';
                        } else if (titleLower.includes('happy new year') || titleLower.includes('firework')) {
                            imagePath = 'assets/images/firework.jpeg';
                        }
                        
                        if (imagePath) {
                            console.log(`Index - News ${news.id}: Auto-detected image in card processing: ${imagePath}`);
                        }
                    }
                    
                    // Force GMI to use correct image
                    if (news.id === 'gmi' || news.title?.toLowerCase().includes('gmi')) {
                        imagePath = 'assets/images/GMI.jpeg';
                        console.log(`Index - News ${news.id}: Force GMI image to assets/images/GMI.jpeg`);
                    }
                    
                    // Clean imagePath - remove any quotes, encoding, or special characters
                    let cleanImagePath = imagePath.replace(/['"]/g, '').trim();
                    // Remove URL encoding
                    cleanImagePath = cleanImagePath.replace(/%22/g, '').replace(/%20/g, ' ');
                    // Ensure it's a valid relative path
                    if (!cleanImagePath.startsWith('assets/')) {
                        // Extract filename and map it
                        const filename = cleanImagePath.split(/[/\\]/).pop();
                        const imageMapForCleanup = {
                            'UTeM-Aeronas.jpeg': 'UTEM.jpeg',
                            'UTEM.jpeg': 'UTEM.jpeg',
                            'GMI.jpeg': 'GMI.jpeg',
                            'GMI.Jpeg': 'GMI.jpeg',
                            'GMI.JPEG': 'GMI.jpeg',
                            'KKTM.jpeg': 'KKTM.jpeg',
                            'USIM.jpeg': 'USIM.jpeg',
                            'UTHM.jpeg': 'UTHM.jpeg',
                            'CHEMTRON.jpeg': 'CHEMTRON.jpeg'
                        };
                        const correctFilename = imageMapForCleanup[filename] || filename;
                        cleanImagePath = `assets/images/${correctFilename}`;
                    }
                    
                    // Final validation - Map news ID to correct image path (ALWAYS OVERRIDE)
                    // Reuse normalizedId and titleLower already declared above
                    const newsImageMap = {
                        'kktm': 'assets/images/KKTM.jpeg',
                        'utem': 'assets/images/UTEM.jpeg',
                        'usim': 'assets/images/USIM.jpeg',
                        'uthm': 'assets/images/UTHM.jpeg',
                        'gmi': 'assets/images/GMI.jpeg',
                        'chemtron': 'assets/images/CHEMTRON.jpeg',
                        'happy-new-year': 'assets/images/firework.jpeg',
                        'happynewyear': 'assets/images/firework.jpeg',
                        'firework': 'assets/images/firework.jpeg'
                    };
                    
                    // Auto-detect image based on title if ID not found (titleLower already declared above)
                    
                    // Check by normalized ID first
                    if (newsImageMap[normalizedId]) {
                        cleanImagePath = newsImageMap[normalizedId];
                        imagePath = newsImageMap[normalizedId];
                        console.log(`Index - News ${news.id}: FORCE OVERRIDE mapped to correct image: ${cleanImagePath}`);
                    } else if (titleLower.includes('kktm')) {
                        cleanImagePath = 'assets/images/KKTM.jpeg';
                        imagePath = cleanImagePath;
                        console.log(`Index - News ${news.id}: Auto-detected KKTM, using KKTM.jpeg`);
                    } else if (titleLower.includes('utem')) {
                        cleanImagePath = 'assets/images/UTEM.jpeg';
                        imagePath = cleanImagePath;
                        console.log(`Index - News ${news.id}: Auto-detected UTeM, using UTEM.jpeg`);
                    } else if (titleLower.includes('usim')) {
                        cleanImagePath = 'assets/images/USIM.jpeg';
                        imagePath = cleanImagePath;
                        console.log(`Index - News ${news.id}: Auto-detected USIM, using USIM.jpeg`);
                    } else if (titleLower.includes('uthm')) {
                        cleanImagePath = 'assets/images/UTHM.jpeg';
                        imagePath = cleanImagePath;
                        console.log(`Index - News ${news.id}: Auto-detected UTHM, using UTHM.jpeg`);
                    } else if (titleLower.includes('gmi')) {
                        cleanImagePath = 'assets/images/GMI.jpeg';
                        imagePath = cleanImagePath;
                        console.log(`Index - News ${news.id}: Auto-detected GMI, using GMI.jpeg`);
                    } else if (titleLower.includes('chemtron')) {
                        cleanImagePath = 'assets/images/CHEMTRON.jpeg';
                        imagePath = cleanImagePath;
                        console.log(`Index - News ${news.id}: Auto-detected CHEMTRON, using CHEMTRON.jpeg`);
                    } else if (titleLower.includes('happy new year') || titleLower.includes('firework')) {
                        cleanImagePath = 'assets/images/firework.jpeg';
                        imagePath = cleanImagePath;
                        console.log(`Index - News ${news.id}: Auto-detected HAPPY NEW YEAR, using firework.jpeg`);
                    }
                    
                    // Final validation - ensure GMI uses correct image (double check)
                    if (news.id === 'gmi' || news.title?.toLowerCase().includes('gmi')) {
                        cleanImagePath = 'assets/images/GMI.jpeg';
                        console.log(`Index - News ${news.id}: Final force GMI cleanImagePath: ${cleanImagePath}`);
                    }
                    
                    // Final validation - ensure CHEMTRON uses correct image (double check)
                    if (news.id === 'chemtron' || news.title?.toLowerCase().includes('chemtron')) {
                        cleanImagePath = 'assets/images/CHEMTRON.jpeg';
                        imagePath = 'assets/images/CHEMTRON.jpeg';
                        console.log(`Index - News ${news.id}: Final force CHEMTRON cleanImagePath: ${cleanImagePath}`);
                    }
                    
                    // Debug: Log GMI image path
                    if (news.id === 'gmi' || news.title?.toLowerCase().includes('gmi')) {
                        console.log(`Index - GMI Debug: news.id=${news.id}, news.title=${news.title}, cleanImagePath=${cleanImagePath}, template.type=${template.type}`);
                    }
                    
                    // Debug: Log CHEMTRON image path (card #6)
                    if (news.id === 'chemtron' || news.title?.toLowerCase().includes('chemtron')) {
                        console.log(`Index - CHEMTRON Debug (Card #6): news.id=${news.id}, news.title=${news.title}, cleanImagePath=${cleanImagePath}, template.type=${template.type}, index=${index}`);
                    }
                    
                    // Debug: Log card-latest-split image path
                    if (template.type === 'latest-split') {
                        console.log(`Index - Latest Split Debug: news.id=${news.id}, news.title=${news.title}, cleanImagePath=${cleanImagePath}, original imagePath=${imagePath}`);
                    }
                    
                    // Skip deleted images - check for common deleted file patterns
                    const deletedImages = [
                        'UTeM-Aeronas.jpeg',
                        'UTeM-Aeronas.Jpeg',
                        'UTeM-Aeronas.JPEG',
                        'UTeM-Aeronas'
                    ];
                    const filename = cleanImagePath.split('/').pop();
                    const filenameWithoutExt = filename.split('.').slice(0, -1).join('.');
                    
                    if (deletedImages.includes(filename) || deletedImages.includes(filenameWithoutExt)) {
                        console.warn(`Index - News ${news.id}: Skipping deleted image: ${filename}`);
                        // Use fallback background color instead of image
                        card.style.backgroundImage = 'none';
                        card.style.backgroundColor = '#1a1a1a';
                    } else {
                        // Escape single quotes for CSS
                        const escapedPath = cleanImagePath.replace(/'/g, "\\'");
                        // Add cache buster to prevent cached deleted images
                        const cacheBuster = `?v=${Date.now()}&t=${news.id}`;
                        
                        // Set background image based on card type
                        if (template.type === 'latest-news' || template.type === 'industry-news') {
                            // For cards with ::after pseudo-element
                            styleContent += `
                                .card-latest-news[data-news-id="${news.id}"]::after,
                                .card-industry-news[data-news-id="${news.id}"]::after {
                                    background-image: url('${escapedPath}${cacheBuster}') !important;
                                }
                            `;
                        } else {
                            // Direct background image for other cards
                            // FORCE correct image path one more time before setting style
                            const finalNewsImageMap = {
                                'kktm': 'assets/images/KKTM.jpeg',
                                'utem': 'assets/images/UTEM.jpeg',
                                'usim': 'assets/images/USIM.jpeg',
                                'uthm': 'assets/images/UTHM.jpeg',
                                'gmi': 'assets/images/GMI.jpeg',
                                'chemtron': 'assets/images/CHEMTRON.jpeg'
                            };
                            
                            let finalImagePath = cleanImagePath;
                            if (finalNewsImageMap[news.id]) {
                                finalImagePath = finalNewsImageMap[news.id];
                                console.log(`Index - News ${news.id}: Final override for style: ${finalImagePath}, template.type=${template.type}`);
                            }
                            
                            const finalEscapedPath = finalImagePath.replace(/'/g, "\\'");
                            
                            styleContent += `
                                .card-news-updates[data-news-id="${news.id}"],
                                .card-aerospace-news[data-news-id="${news.id}"],
                                .card-news-ac[data-news-id="${news.id}"],
                                .card-latest-split[data-news-id="${news.id}"] {
                                    background-image: url('${finalEscapedPath}${cacheBuster}') !important;
                                    background-size: cover !important;
                                    background-position: center !important;
                                }
                            `;
                            
                            // ALWAYS set directly on card element for ALL cards (especially for latest-split)
                            // FINAL OVERRIDE: Always use correct image based on news.id
                            const forceImageMap = {
                                'kktm': 'assets/images/KKTM.jpeg',
                                'utem': 'assets/images/UTEM.jpeg',
                                'usim': 'assets/images/USIM.jpeg',
                                'uthm': 'assets/images/UTHM.jpeg',
                                'gmi': 'assets/images/GMI.jpeg',
                                'chemtron': 'assets/images/CHEMTRON.jpeg'
                            };
                            
                            let forceImagePath = finalImagePath;
                            if (forceImageMap[news.id]) {
                                forceImagePath = forceImageMap[news.id];
                                console.log(`Index - News ${news.id}: FORCE image override: ${forceImagePath}`);
                            }
                            
                            const forceEscapedPath = forceImagePath.replace(/'/g, "\\'");
                            card.style.setProperty('background-image', `url('${forceEscapedPath}${cacheBuster}')`, 'important');
                            card.style.setProperty('background-size', 'cover', 'important');
                            card.style.setProperty('background-position', 'center', 'important');
                            
                            if (template.type === 'latest-split') {
                                console.log(`Index - Latest Split: Directly set image on card element: ${forceEscapedPath}${cacheBuster}, news.id=${news.id}, news.title=${news.title}`);
                            }
                        }
                        
                        // Add error handler for image loading (async check)
                        const img = new Image();
                        img.onerror = () => {
                            console.warn(`Index - News ${news.id}: Image failed to load: ${cleanImagePath}`);
                            const cardElement = grid.querySelector(`[data-news-id="${news.id}"]`);
                            if (cardElement) {
                                cardElement.style.backgroundImage = 'none';
                                cardElement.style.backgroundColor = '#1a1a1a';
                            }
                        };
                        img.onload = () => {
                            // Force correct image directly on card element after image loads (for ALL news)
                            const onLoadNewsImageMap = {
                                'kktm': 'assets/images/KKTM.jpeg',
                                'utem': 'assets/images/UTEM.jpeg',
                                'usim': 'assets/images/USIM.jpeg',
                                'uthm': 'assets/images/UTHM.jpeg',
                                'gmi': 'assets/images/GMI.jpeg',
                                'chemtron': 'assets/images/CHEMTRON.jpeg'
                            };
                            
                            let onLoadImagePath = cleanImagePath;
                            if (onLoadNewsImageMap[news.id]) {
                                onLoadImagePath = onLoadNewsImageMap[news.id];
                            }
                            
                            // Set correct image on card after load (especially for latest-split)
                            const cardElement = grid.querySelector(`[data-news-id="${news.id}"]`);
                            if (cardElement) {
                                const onLoadCacheBuster = `?v=${Date.now()}&t=${news.id}&loaded`;
                                const onLoadEscapedPath = onLoadImagePath.replace(/'/g, "\\'");
                                cardElement.style.setProperty('background-image', `url('${onLoadEscapedPath}${onLoadCacheBuster}')`, 'important');
                                cardElement.style.setProperty('background-size', 'cover', 'important');
                                cardElement.style.setProperty('background-position', 'center', 'important');
                                
                                if (template.type === 'latest-split') {
                                    console.log(`Index - Latest Split After Load: Set image on card: ${onLoadEscapedPath}${onLoadCacheBuster}, news.id=${news.id}`);
                                }
                            }
                            
                            // Force GMI image directly on card element after image loads
                            if (news.id === 'gmi' || news.title?.toLowerCase().includes('gmi')) {
                                const cardElement = grid.querySelector(`[data-news-id="${news.id}"]`);
                                if (cardElement) {
                                    cardElement.style.backgroundImage = `url('assets/images/GMI.jpeg?force=${Date.now()}')`;
                                    cardElement.style.backgroundSize = 'cover';
                                    cardElement.style.backgroundPosition = 'center';
                                    console.log(`Index - GMI: Directly set background image on card element`);
                                }
                            }
                            
                            // Force CHEMTRON image directly on card element after image loads (card #6)
                            if (news.id === 'chemtron' || news.title?.toLowerCase().includes('chemtron')) {
                                const cardElement = grid.querySelector(`[data-news-id="${news.id}"]`);
                                if (cardElement) {
                                    cardElement.style.backgroundImage = `url('assets/images/CHEMTRON.jpeg?force=${Date.now()}')`;
                                    cardElement.style.backgroundSize = 'cover';
                                    cardElement.style.backgroundPosition = 'center';
                                    console.log(`Index - CHEMTRON (Card #6): Directly set background image on card element after image load`);
                                }
                            }
                        };
                        img.src = cleanImagePath;
                    }
                }
            });
            
            // Apply all styles at once
            if (styleElement && styleContent) {
                styleElement.textContent = styleContent;
            }
            
            // AFTER all cards are rendered, FORCE correct images for ALL news cards (especially latest-split)
            newsToShow.forEach((news, index) => {
                const card = grid.querySelector(`[data-news-id="${news.id}"]`);
                if (card) {
                    // Normalize news.id to lowercase for consistent mapping
                    const normalizedId = (news.id || '').toLowerCase().trim();
                    const titleLower = (news.title || '').toLowerCase();
                    
                    const finalNewsImageMap = {
                        'kktm': 'assets/images/KKTM.jpeg',
                        'utem': 'assets/images/UTEM.jpeg',
                        'usim': 'assets/images/USIM.jpeg',
                        'uthm': 'assets/images/UTHM.jpeg',
                        'gmi': 'assets/images/GMI.jpeg',
                        'chemtron': 'assets/images/CHEMTRON.jpeg',
                        'happy-new-year': 'assets/images/firework.jpeg',
                        'happynewyear': 'assets/images/firework.jpeg',
                        'firework': 'assets/images/firework.jpeg'
                    };
                    
                    // ALWAYS use correct image based on news.id - this is the FINAL override
                    let finalImagePath = finalNewsImageMap[normalizedId];
                    
                    // Auto-detect image based on title if ID not found
                    if (!finalImagePath) {
                        if (titleLower.includes('kktm')) {
                            finalImagePath = 'assets/images/KKTM.jpeg';
                        } else if (titleLower.includes('utem')) {
                            finalImagePath = 'assets/images/UTEM.jpeg';
                        } else if (titleLower.includes('usim')) {
                            finalImagePath = 'assets/images/USIM.jpeg';
                        } else if (titleLower.includes('uthm')) {
                            finalImagePath = 'assets/images/UTHM.jpeg';
                        } else if (titleLower.includes('gmi')) {
                            finalImagePath = 'assets/images/GMI.jpeg';
                        } else if (titleLower.includes('chemtron')) {
                            finalImagePath = 'assets/images/CHEMTRON.jpeg';
                        } else if (titleLower.includes('happy new year') || titleLower.includes('firework')) {
                            finalImagePath = 'assets/images/firework.jpeg';
                        }
                        
                        if (finalImagePath) {
                            finalNewsImageMap[normalizedId] = finalImagePath; // Cache it
                            console.log(`Index - News ${news.id} (${news.title}): Final override - Auto-detected by title, using ${finalImagePath}`);
                        }
                    }
                    
                    if (finalImagePath) {
                        const finalCacheBuster = `?v=${Date.now()}&t=${news.id}&final`;
                        const finalEscapedPath = finalImagePath.replace(/'/g, "\\'");
                        
                        // Force correct image on card element for ALL card types
                        card.style.setProperty('background-image', `url('${finalEscapedPath}${finalCacheBuster}')`, 'important');
                        card.style.setProperty('background-size', 'cover', 'important');
                        card.style.setProperty('background-position', 'center', 'important');
                        
                        // Also update CSS style element for all card types
                        if (styleElement) {
                            const template = cardTemplates[index % cardTemplates.length];
                            const additionalStyle = `
                                .card-latest-news[data-news-id="${news.id}"]::after,
                                .card-news-updates[data-news-id="${news.id}"],
                                .card-industry-news[data-news-id="${news.id}"]::after,
                                .card-aerospace-news[data-news-id="${news.id}"],
                                .card-news-ac[data-news-id="${news.id}"],
                                .card-latest-split[data-news-id="${news.id}"] {
                                    background-image: url('${finalEscapedPath}${finalCacheBuster}') !important;
                                    background-size: cover !important;
                                    background-position: center !important;
                                }
                            `;
                            styleElement.textContent += additionalStyle;
                        }
                        
                        console.log(`Index - Final Fix ALL Cards: news.id=${news.id}, news.title=${news.title}, image=${finalImagePath}, card.className=${card.className}`);
                    } else {
                        // Last resort: Auto-detect by title
                        const titleLower = (news.title || '').toLowerCase();
                        let lastResortImage = '';
                        
                        if (titleLower.includes('kktm')) {
                            lastResortImage = 'assets/images/KKTM.jpeg';
                        } else if (titleLower.includes('utem')) {
                            lastResortImage = 'assets/images/UTEM.jpeg';
                        } else if (titleLower.includes('usim')) {
                            lastResortImage = 'assets/images/USIM.jpeg';
                        } else if (titleLower.includes('uthm')) {
                            lastResortImage = 'assets/images/UTHM.jpeg';
                        } else if (titleLower.includes('gmi')) {
                            lastResortImage = 'assets/images/GMI.jpeg';
                        } else if (titleLower.includes('chemtron')) {
                            lastResortImage = 'assets/images/CHEMTRON.jpeg';
                        } else if (titleLower.includes('happy new year') || titleLower.includes('firework')) {
                            lastResortImage = 'assets/images/firework.jpeg';
                        }
                        
                        if (lastResortImage) {
                            const finalCacheBuster = `?v=${Date.now()}&t=${news.id}&final-auto`;
                            const finalEscapedPath = lastResortImage.replace(/'/g, "\\'");
                            card.style.setProperty('background-image', `url('${finalEscapedPath}${finalCacheBuster}')`, 'important');
                            card.style.setProperty('background-size', 'cover', 'important');
                            card.style.setProperty('background-position', 'center', 'important');
                            console.log(`Index - News ${news.id} (${news.title}): Last resort auto-detected by title, using ${lastResortImage}`);
                        } else {
                            console.warn(`Index - News ${news.id} (${news.title}): No image mapping found!`);
                        }
                    }
                }
            });
            
            // Force ALL news images immediately (synchronous) - override Firebase/deleted images
            newsToShow.forEach((news, index) => {
                const allNewsImageMap = {
                    'kktm': 'assets/images/KKTM.jpeg',
                    'utem': 'assets/images/UTEM.jpeg',
                    'usim': 'assets/images/USIM.jpeg',
                    'uthm': 'assets/images/UTHM.jpeg',
                    'gmi': 'assets/images/GMI.jpeg',
                    'chemtron': 'assets/images/CHEMTRON.jpeg',
                    'happy-new-year': 'assets/images/firework.jpeg',
                    'happynewyear': 'assets/images/firework.jpeg',
                    'firework': 'assets/images/firework.jpeg'
                };
                
                // Normalize ID and auto-detect by title
                const normalizedId = (news.id || '').toLowerCase().trim();
                const titleLower = (news.title || '').toLowerCase();
                
                let correctImagePath = allNewsImageMap[normalizedId];
                if (!correctImagePath) {
                    if (titleLower.includes('kktm')) {
                        correctImagePath = 'assets/images/KKTM.jpeg';
                    } else if (titleLower.includes('utem')) {
                        correctImagePath = 'assets/images/UTEM.jpeg';
                    } else if (titleLower.includes('usim')) {
                        correctImagePath = 'assets/images/USIM.jpeg';
                    } else if (titleLower.includes('uthm')) {
                        correctImagePath = 'assets/images/UTHM.jpeg';
                    } else if (titleLower.includes('gmi')) {
                        correctImagePath = 'assets/images/GMI.jpeg';
                    } else if (titleLower.includes('chemtron')) {
                        correctImagePath = 'assets/images/CHEMTRON.jpeg';
                    } else if (titleLower.includes('happy new year') || titleLower.includes('firework')) {
                        correctImagePath = 'assets/images/firework.jpeg';
                    }
                }
                
                if (correctImagePath) {
                    const card = grid.querySelector(`[data-news-id="${news.id}"]`);
                    if (card) {
                        // Directly set style on card element - override Firebase/deleted images
                        const escapedPath = correctImagePath.replace(/'/g, "\\'");
                        const cacheBuster = `?v=${Date.now()}&force=${news.id}&immediate`;
                        card.style.backgroundImage = `url('${escapedPath}${cacheBuster}')`;
                        card.style.backgroundSize = 'cover';
                        card.style.backgroundPosition = 'center';
                        console.log(`Index - News ${news.id}: Immediately set background image via card.style (override Firebase/deleted): ${escapedPath}${cacheBuster}`);
                    }
                }
            });
            
            // Force ALL news cards to use correct images after all styles applied (additional safety)
            setTimeout(() => {
                const allNewsImageMap = {
                    'kktm': 'assets/images/KKTM.jpeg',
                    'utem': 'assets/images/UTEM.jpeg',
                    'usim': 'assets/images/USIM.jpeg',
                    'uthm': 'assets/images/UTHM.jpeg',
                    'gmi': 'assets/images/GMI.jpeg',
                    'chemtron': 'assets/images/CHEMTRON.jpeg',
                    'happy-new-year': 'assets/images/firework.jpeg',
                    'happynewyear': 'assets/images/firework.jpeg',
                    'firework': 'assets/images/firework.jpeg'
                };
                
                // Force correct images for ALL news cards (especially to override Firebase deleted images)
                newsToShow.forEach(news => {
                    // Normalize ID and auto-detect by title
                    const normalizedId = (news.id || '').toLowerCase().trim();
                    const titleLower = (news.title || '').toLowerCase();
                    
                    let correctImagePath = allNewsImageMap[normalizedId];
                    if (!correctImagePath) {
                        if (titleLower.includes('kktm')) {
                            correctImagePath = 'assets/images/KKTM.jpeg';
                        } else if (titleLower.includes('utem')) {
                            correctImagePath = 'assets/images/UTEM.jpeg';
                        } else if (titleLower.includes('usim')) {
                            correctImagePath = 'assets/images/USIM.jpeg';
                        } else if (titleLower.includes('uthm')) {
                            correctImagePath = 'assets/images/UTHM.jpeg';
                        } else if (titleLower.includes('gmi')) {
                            correctImagePath = 'assets/images/GMI.jpeg';
                        } else if (titleLower.includes('chemtron')) {
                            correctImagePath = 'assets/images/CHEMTRON.jpeg';
                        } else if (titleLower.includes('happy new year') || titleLower.includes('firework')) {
                            correctImagePath = 'assets/images/firework.jpeg';
                        }
                    }
                    
                    if (correctImagePath) {
                        const card = grid.querySelector(`[data-news-id="${news.id}"]`);
                        if (card) {
                            const finalPath = `${correctImagePath}?v=${Date.now()}&force3&${news.id}`;
                            card.style.setProperty('background-image', `url('${finalPath}')`, 'important');
                            card.style.setProperty('background-size', 'cover', 'important');
                            card.style.setProperty('background-position', 'center', 'important');
                            console.log(`Index - News ${news.id}: Final force via setTimeout override Firebase/deleted image: ${finalPath}`);
                        }
                    }
                });
            }, 100);
        }
        
        // Load news from Firestore or use local data
        async function loadNews() {
            try {
                const news = await loadNewsFromFirestore();
                if (news && news.length > 0) {
                    // Override images from Firebase with correct local images based on news.id
                    const imageOverrideMap = {
                        'kktm': 'assets/images/KKTM.jpeg',
                        'utem': 'assets/images/UTEM.jpeg',
                        'usim': 'assets/images/USIM.jpeg',
                        'uthm': 'assets/images/UTHM.jpeg',
                        'gmi': 'assets/images/GMI.jpeg',
                        'chemtron': 'assets/images/CHEMTRON.jpeg',
                        'happy-new-year': 'assets/images/firework.jpeg',
                        'happynewyear': 'assets/images/firework.jpeg',
                        'firework': 'assets/images/firework.jpeg'
                    };
                    
                    // Force override images for all news from Firebase
                    news.forEach(newsItem => {
                        // Normalize ID
                        const normalizedId = (newsItem.id || '').toLowerCase().trim();
                        const titleLower = (newsItem.title || '').toLowerCase();
                        
                        // Check by normalized ID first
                        let imagePath = imageOverrideMap[normalizedId];
                        
                        // Auto-detect by title if ID not found
                        if (!imagePath) {
                            if (titleLower.includes('kktm')) {
                                imagePath = 'assets/images/KKTM.jpeg';
                            } else if (titleLower.includes('utem')) {
                                imagePath = 'assets/images/UTEM.jpeg';
                            } else if (titleLower.includes('usim')) {
                                imagePath = 'assets/images/USIM.jpeg';
                            } else if (titleLower.includes('uthm')) {
                                imagePath = 'assets/images/UTHM.jpeg';
                            } else if (titleLower.includes('gmi')) {
                                imagePath = 'assets/images/GMI.jpeg';
                            } else if (titleLower.includes('chemtron')) {
                                imagePath = 'assets/images/CHEMTRON.jpeg';
                            } else if (titleLower.includes('happy new year') || titleLower.includes('firework')) {
                                imagePath = 'assets/images/firework.jpeg';
                            }
                        }
                        
                        if (imagePath) {
                            newsItem.image = imagePath;
                            newsItem.imageUrl = imagePath;
                            console.log(`Index - Override Firebase image for ${newsItem.id}: ${imagePath}`);
                        }
                    });
                    
                    renderNewsCards(news);
                } else {
                    // Fallback to local data
                    renderNewsCards(newsData);
                }
            } catch (error) {
                console.error('Error loading news:', error);
                // Fallback to local data
                renderNewsCards(newsData);
            }
        }
        
        // Initialize news cards
        loadNews();
    </script>

    <script>
        // Scroll effect: background gets darker as you scroll down
        const scrollDarkOverlay = document.getElementById('scrollDarkOverlay');
        
        window.addEventListener('scroll', () => {
            const scrollPosition = window.pageYOffset;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            const scrollPercentage = scrollPosition / (documentHeight - windowHeight);
            
            // Calculate opacity: 0 at top, up to 0.6 at bottom
            const opacity = Math.min(scrollPercentage * 0.6, 0.6);
            scrollDarkOverlay.style.opacity = opacity;
        }, { passive: true });

        // Smooth scroll to video section and popup effect
        const getStartedBtn = document.getElementById('getStartedBtn');
        const videoSection = document.getElementById('video-section');
        
        if (getStartedBtn && videoSection) {
            getStartedBtn.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Smooth scroll to video section
                videoSection.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Add popup effect after scroll
                setTimeout(() => {
                    videoSection.classList.add('video-popup');
                    setTimeout(() => {
                        videoSection.classList.remove('video-popup');
                    }, 1000);
                }, 500);
            });
        }

        // Video controls - Play/Pause and Sound
        const newsVideo = document.getElementById('newsVideo');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const soundBtn = document.getElementById('soundBtn');
        
        if (!playPauseBtn || !soundBtn) {
            console.error('Video control buttons not found!');
        }
        
        const playIcon = playPauseBtn?.querySelector('.play-icon');
        const pauseIcon = playPauseBtn?.querySelector('.pause-icon');
        const muteIcon = soundBtn?.querySelector('.mute-icon');
        const unmuteIcon = soundBtn?.querySelector('.unmute-icon');

        // Update play/pause icon based on video state
        function updatePlayPauseIcon() {
            if (newsVideo && playIcon && pauseIcon) {
                if (newsVideo.paused) {
                    playIcon.style.display = 'inline';
                    pauseIcon.style.display = 'none';
                } else {
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'inline';
                }
            }
        }

        // Update sound icon based on mute state
        function updateSoundIcon() {
            if (newsVideo && muteIcon && unmuteIcon) {
                if (newsVideo.muted) {
                    muteIcon.style.display = 'inline';
                    unmuteIcon.style.display = 'none';
                } else {
                    muteIcon.style.display = 'none';
                    unmuteIcon.style.display = 'inline';
                }
            }
        }

        // Play/Pause button handler
        if (playPauseBtn && newsVideo) {
            playPauseBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (newsVideo.paused) {
                    newsVideo.play();
                } else {
                    newsVideo.pause();
                }
                updatePlayPauseIcon();
            });
        }

        // Sound button handler - hanya toggle mute/unmute, tidak pause video
        if (soundBtn && newsVideo) {
            // Flag to track if sound button was clicked
            let soundButtonClicked = false;
            
            soundBtn.addEventListener('mousedown', function(e) {
                soundButtonClicked = true;
            }, true);
            
            soundBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                soundButtonClicked = true;
                
                // Toggle mute/unmute sahaja - tidak pause/play video
                if (newsVideo.muted) {
                    // Unmute: set muted to false and ensure volume is max
                    newsVideo.muted = false;
                    newsVideo.volume = 1.0;
                } else {
                    // Mute: set muted to true
                    newsVideo.muted = true;
                }
                
                // Update icon immediately
                updateSoundIcon();
                
                // Reset flag after a short delay
                setTimeout(() => {
                    soundButtonClicked = false;
                }, 100);
                
                return false;
            }, true); // Use capture phase to ensure it fires first
            
            // Prevent video from pausing when sound button is clicked
            if (newsVideo) {
                newsVideo.addEventListener('click', function(e) {
                    if (soundButtonClicked) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                }, true);
            }
        }

        // Listen to video events to update icons
        if (newsVideo) {
            newsVideo.addEventListener('play', updatePlayPauseIcon);
            newsVideo.addEventListener('pause', updatePlayPauseIcon);
            newsVideo.addEventListener('volumechange', updateSoundIcon);
            newsVideo.addEventListener('loadedmetadata', function() {
                // Ensure volume is set when video loads
                newsVideo.volume = 1.0;
                updateSoundIcon();
            });
            newsVideo.addEventListener('canplay', function() {
                // Ensure volume is set when video can play
                newsVideo.volume = 1.0;
                updateSoundIcon();
            });
            
            // Initialize video - set volume to max, start muted for autoplay policy
            newsVideo.volume = 1.0;
            newsVideo.muted = true;
            
            // Initialize icons
            updatePlayPauseIcon();
            updateSoundIcon();
        }

    </script>

    <script>
        // Close navigation mobile apabila page load (pastikan tidak ada menu terbuka)
        function closeMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const headerNav = document.getElementById('headerNav');
            const headerRight = document.querySelector('.header-right');
            
            if (mobileMenuToggle && headerNav) {
                mobileMenuToggle.classList.remove('active');
                headerNav.classList.remove('mobile-open');
                if (headerRight) {
                    headerRight.classList.remove('mobile-open');
                }
                document.body.classList.remove('menu-open');
                document.documentElement.classList.remove('menu-open');
            }
            
            // Force remove overlay dengan menambahkan style untuk hide pseudo-element
            const existingStyle = document.getElementById('force-remove-overlay');
            if (existingStyle) {
                document.head.removeChild(existingStyle);
            }
            
            const style = document.createElement('style');
            style.id = 'force-remove-overlay';
            style.textContent = 'body::before, body.menu-open::before { display: none !important; content: none !important; opacity: 0 !important; pointer-events: none !important; }';
            document.head.appendChild(style);
        }

        // Close menu immediately on page load
        closeMobileMenu();
        
        // Also close on DOMContentLoaded and window load untuk pastikan
        document.addEventListener('DOMContentLoaded', closeMobileMenu);
        window.addEventListener('load', closeMobileMenu);

        // Mobile menu toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const headerNav = document.getElementById('headerNav');
        const headerRight = document.querySelector('.header-right');

        if (mobileMenuToggle && headerNav) {
            mobileMenuToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                mobileMenuToggle.classList.toggle('active');
                headerNav.classList.toggle('mobile-open');
                if (headerRight) {
                    headerRight.classList.toggle('mobile-open');
                }
                document.body.classList.toggle('menu-open');
            }, { passive: false });

            // Toggle dropdown untuk Aircraft di mobile
            const navDropdown = headerNav.querySelector('.nav-dropdown');
            if (navDropdown) {
                const dropdownLink = navDropdown.querySelector(':scope > a');
                if (dropdownLink) {
                    dropdownLink.addEventListener('click', function(e) {
                        // Jangan navigate jika ada dropdown menu
                        if (navDropdown.querySelector('.dropdown-menu')) {
                            e.preventDefault();
                            e.stopPropagation();
                            navDropdown.classList.toggle('active');
                        }
                    });
                }
            }

            // Close menu when clicking on any navigation link (kecuali dropdown parent)
            const navLinks = headerNav.querySelectorAll('a');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    // Skip jika ini adalah dropdown parent link
                    const parentDropdown = link.closest('.nav-dropdown');
                    if (parentDropdown) {
                        const parentLink = parentDropdown.querySelector(':scope > a');
                        if (link === parentLink) {
                            // Ini adalah dropdown parent - biarkan dropdown toggle handle
                            return;
                        }
                    }
                    
                    // Pastikan navigation proceed - jangan prevent default atau stop propagation
                    // Close menu immediately untuk allow navigation
                    mobileMenuToggle.classList.remove('active');
                    headerNav.classList.remove('mobile-open');
                    if (headerRight) {
                        headerRight.classList.remove('mobile-open');
                    }
                    document.body.classList.remove('menu-open');
                    
                    // Navigation akan proceed secara normal - tidak ada preventDefault() atau stopPropagation()
                    // Link akan navigate ke href secara normal
                });
            });

            // Close menu when clicking outside (tapi jangan block navigation links)
            document.addEventListener('click', function(event) {
                // Skip jika click pada navigation link - biarkan navigation proceed
                if (event.target.closest('.header-nav a')) {
                    return;
                }
                
                if (!headerNav.contains(event.target) && !mobileMenuToggle.contains(event.target)) {
                    mobileMenuToggle.classList.remove('active');
                    headerNav.classList.remove('mobile-open');
                    if (headerRight) {
                        headerRight.classList.remove('mobile-open');
                    }
                    document.body.classList.remove('menu-open');
                }
            });
        }
    </script>

    <script>
        // Story Gallery Card Random Slideshow
        (function() {
            const galleryCard = document.getElementById('storyGalleryCard');
            if (!galleryCard) return;

            const slides = galleryCard.querySelectorAll('.story-gallery-slide');
            if (slides.length < 2) return;

            let currentIndex = 0;
            let lastRandomIndex = -1;

            function getRandomIndex() {
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * slides.length);
                } while (randomIndex === lastRandomIndex && slides.length > 1);
                lastRandomIndex = randomIndex;
                return randomIndex;
            }

            function showSlide(index) {
                slides.forEach((slide, i) => {
                    slide.classList.toggle('active', i === index);
                });
            }

            function nextSlide() {
                currentIndex = getRandomIndex();
                showSlide(currentIndex);
            }

            // Initialize with random slide
            currentIndex = getRandomIndex();
            showSlide(currentIndex);

            // Auto-slide every 5 seconds
            setInterval(nextSlide, 5000);
        })();
    </script>
</body>
</html>
