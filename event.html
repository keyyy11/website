<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event ‚Äì Aeronas Aerocraft</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="theme-dark">
    <!-- Header -->
    <header class="site-header">
        <div class="header-left">
            <a href="index.html" class="brand-mark">
                <img src="assets/images/Logo-Icon-Only.png" alt="Logo" class="logo" />
                <span class="brand-text">Aeronas Aerocraft</span>
            </a>
        </div>

        <nav class="header-nav" id="headerNav">
            <div class="mobile-nav-logo">
                <a href="index.html" class="brand-mark">
                    <img src="assets/images/Logo-Icon-Only.png" alt="Logo" class="logo">
                    <span class="brand-text">Aeronas Aerocraft</span>
                </a>
            </div>
            <a href="index.html">Home</a>
            <div class="nav-dropdown">
                <a href="aircraft.html">Aircraft</a>
                <div class="dropdown-menu">
                    <a href="aircraft.html#manufacturing">Manufacturing</a>
                    <a href="technology.html">Technology</a>
                    <a href="compliance.html">Compliance</a>
                </div>
            </div>
            <a href="about.html">About</a>
            <a href="services.html">Careers</a>
            <a href="news.html">News</a>
            <a href="event.html" class="active">Event</a>
            <a href="contact.html" class="nav-mobile-contact">Contact Us</a>
        </nav>

        <div class="header-right">
            <a href="contact.html" class="nav-cta">Contact Us</a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="event-page-main" id="eventPageMain">
        <div class="event-background-wrapper" id="eventBackground">
            <section class="event-hero-section" id="eventHeroSection">
                <div class="event-hero-content">
                    <p class="event-hero-label">UPCOMING EVENTS & ANNOUNCEMENTS</p>
                    <h1 class="event-hero-title" id="eventHeroTitle">EVENTS</h1>
                </div>
            </section>

            <section class="event-categories-section" id="eventCategoriesSection">
                <div class="event-categories-grid" id="eventsGrid">
                    <!-- Event cards will be loaded here from Firebase -->
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                        Loading events...
                    </div>
                </div>
            </section>
            
            <!-- Fullscreen Event View -->
            <div class="event-fullscreen-view" id="eventFullscreenView">
                <button class="event-close-btn" id="eventCloseBtn">√ó</button>
                <div class="event-fullscreen-content">
                    <div class="event-fullscreen-image" id="eventFullscreenImage"></div>
                    <div class="event-fullscreen-text-wrapper">
                        <div class="event-fullscreen-text" id="eventFullscreenText"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-contact">
            <div class="footer-col">
                <h4>TEL</h4>
                <p>07-4450444</p>
            </div>
            <div class="footer-col">
                <h4>E-MAIL</h4>
                <p>admin@aeronasgrp.com</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>¬© 2025 Aeronas Aerocraft. All rights reserved.</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBU-ZNBFukfPWsuD2JYwIuHPshVYeSIWew",
            authDomain: "aeronas-aerocraft.firebaseapp.com",
            projectId: "aeronas-aerocraft",
            storageBucket: "aeronas-aerocraft.firebasestorage.app",
            messagingSenderId: "576218545628",
            appId: "1:576218545628:web:6e7483b743b4c2e0336319",
            measurementId: "G-CC8VQY3RCN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Dynamic background image change on hover
        const eventBackground = document.getElementById('eventBackground');
        const eventsGrid = document.querySelector('.event-categories-grid');
        
        // Function to update background image
        function updateBackground(imagePath) {
            if (eventBackground && imagePath) {
                let cleanPath = imagePath.trim();
                
                // Remove file:/// prefix if present
                cleanPath = cleanPath.replace(/^file:\/\/\//, '');
                
                // Convert absolute Windows paths to relative
                if (cleanPath.includes('C:\\') || cleanPath.includes('C:/') || cleanPath.includes('\\')) {
                    const filename = cleanPath.split(/[/\\]/).pop();
                    cleanPath = `assets/images/${filename}`;
                }
                
                // Remove quotes
                cleanPath = cleanPath.replace(/['"]/g, '');
                cleanPath = cleanPath.replace(/%22/g, '').replace(/%20/g, ' ');
                
                // Decode URI if needed
                if (cleanPath.includes('%')) {
                    try {
                        cleanPath = decodeURIComponent(cleanPath);
                    } catch (e) {
                        console.warn('Failed to decode image path:', cleanPath);
                    }
                }
                
                // Ensure it's a relative path
                if (cleanPath && !cleanPath.startsWith('assets/') && !cleanPath.startsWith('/assets/') && !cleanPath.startsWith('./assets/') && !cleanPath.startsWith('http')) {
                    if (!cleanPath.includes('/')) {
                        cleanPath = `assets/images/${cleanPath}`;
                    } else {
                        const filename = cleanPath.split('/').pop();
                        cleanPath = `assets/images/${filename}`;
                    }
                }
                
                // Final cleanup
                cleanPath = cleanPath.replace(/^file:\/\/\//, '').replace(/^C:[/\\]/, '').replace(/^\/C:[/\\]/, '');
                
                // Use default if still invalid
                if (!cleanPath || cleanPath === '') {
                    cleanPath = 'assets/images/02.jpeg';
                }
                
                let style = document.getElementById('event-bg-dynamic');
                if (!style) {
                    style = document.createElement('style');
                    style.id = 'event-bg-dynamic';
                    document.head.appendChild(style);
                }
                const escapedPath = cleanPath.replace(/'/g, "\\'");
                style.textContent = `.event-background-wrapper::after { background-image: url('${escapedPath}') !important; background-size: cover !important; background-position: center !important; transition: background-image 0.5s ease !important; }`;
            }
        }
        
        // Function to render event cards
        function renderEventCards(eventsArray) {
            if (!eventsGrid) {
                console.error('Events grid not found');
                return;
            }
            
            if (!eventsArray || eventsArray.length === 0) {
                eventsGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5); grid-column: 1 / -1;">
                        <p>No upcoming events found.</p>
                        <p style="font-size: 14px; margin-top: 10px;">Please add events through the admin dashboard.</p>
                    </div>
                `;
                return;
            }
            
            // Clear existing cards
            eventsGrid.innerHTML = '';
            
            // Sort by date (upcoming first)
            const sortedEvents = [...eventsArray].sort((a, b) => {
                const dateA = a.data.date || '';
                const dateB = b.data.date || '';
                return dateA.localeCompare(dateB);
            });
            
            // Render cards
            sortedEvents.forEach(({ id, data: event }, index) => {
                const isActive = index === 0; // First card is active by default
                const card = document.createElement('div');
                
                // Fix image path - convert absolute Windows path to relative path
                let imagePath = event.image || '';
                
                // If path contains Windows absolute path, convert to relative
                if (imagePath.includes('C:\\') || imagePath.includes('C:/') || imagePath.includes('\\') || imagePath.includes('file:///')) {
                    // Extract filename from absolute path
                    const filename = imagePath.split(/[/\\]/).pop();
                    // Remove file:/// prefix if present
                    const cleanFilename = filename.replace(/^file:\/\/\//, '').split('/').pop();
                    imagePath = `assets/images/${cleanFilename}`;
                    // Silent conversion - no console logging needed
                }
                
                // Ensure path is relative (starts with assets/)
                if (imagePath && !imagePath.startsWith('assets/') && !imagePath.startsWith('/assets/') && !imagePath.startsWith('./assets/') && !imagePath.startsWith('http')) {
                    // If just filename, add assets/images/ prefix
                    if (!imagePath.includes('/')) {
                        imagePath = `assets/images/${imagePath}`;
                    } else {
                        // If has path but doesn't start with assets/, try to fix it
                        const filename = imagePath.split('/').pop();
                        imagePath = `assets/images/${filename}`;
                    }
                }
                
                // Clean up any remaining file:/// or absolute path references
                imagePath = imagePath.replace(/^file:\/\/\//, '').replace(/^C:[/\\]/, '').replace(/^\/C:[/\\]/, '');
                
                const eventDate = event.dateDisplay || (event.date ? new Date(event.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Date TBA');
                
                card.className = `event-category-card ${isActive ? 'active' : ''}`;
                card.id = `event-${id}`;
                // Use default background if no image
                const bgImagePath = imagePath || 'assets/images/02.jpeg';
                card.setAttribute('data-bg', bgImagePath);
                card.setAttribute('data-date', event.date || '');
                card.setAttribute('data-title', event.title || 'Untitled');
                card.setAttribute('data-description', event.description || 'No description available');
                card.setAttribute('data-image', imagePath || '');
                card.setAttribute('data-location', event.location || '');
                card.setAttribute('data-link', event.link || '');
                
                // Escape HTML to prevent XSS
                const safeTitle = (event.title || 'Untitled Event').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const safeDescription = (event.description || 'No description available').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const safeLocation = (event.location || 'TBA').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                card.innerHTML = `
                    <h3>${safeTitle}</h3>
                    <p>Date : ${eventDate}</p>
                    <p>Location : ${safeLocation}</p>
                    <div class="event-popup-content">
                        <div class="event-popup-image">
                            ${imagePath ? `<img src="${imagePath}" alt="${safeTitle}" onerror="console.error('Failed to load event image:', '${imagePath}'); this.parentElement.innerHTML='';" loading="lazy">` : ''}
                        </div>
                        <div class="event-popup-text">
                            <p>${safeDescription}</p>
                            ${event.location ? `<p style="margin-top: 10px;"><strong>Location:</strong> ${safeLocation}</p>` : ''}
                        </div>
                    </div>
                `;
                
                eventsGrid.appendChild(card);
            });
            
            // Set initial background
            if (sortedEvents.length > 0) {
                // Get the first event's image path (already normalized)
                const firstEvent = sortedEvents[0];
                let firstImagePath = firstEvent.data.image || '';
                
                // Normalize first image path too
                if (firstImagePath.includes('C:\\') || firstImagePath.includes('C:/') || firstImagePath.includes('\\') || firstImagePath.includes('file:///')) {
                    const filename = firstImagePath.split(/[/\\]/).pop();
                    const cleanFilename = filename.replace(/^file:\/\/\//, '').split('/').pop();
                    firstImagePath = `assets/images/${cleanFilename}`;
                }
                
                if (firstImagePath && !firstImagePath.startsWith('assets/') && !firstImagePath.startsWith('http')) {
                    const filename = firstImagePath.split('/').pop();
                    firstImagePath = `assets/images/${filename}`;
                }
                
                firstImagePath = firstImagePath.replace(/^file:\/\/\//, '').replace(/^C:[/\\]/, '').replace(/^\/C:[/\\]/, '');
                
                if (firstImagePath) {
                    updateBackground(firstImagePath);
                } else {
                    updateBackground('assets/images/02.jpeg');
                }
            }
            
            // Setup event listeners for cards
            setupCardListeners();
        }
        
        // Setup card event listeners
        function setupCardListeners() {
            const categoryCards = document.querySelectorAll('.event-category-card');
            const eventHeroSection = document.getElementById('eventHeroSection');
            const eventCategoriesSection = document.getElementById('eventCategoriesSection');
            const eventFullscreenView = document.getElementById('eventFullscreenView');
            const eventCloseBtn = document.getElementById('eventCloseBtn');
            const eventFullscreenImage = document.getElementById('eventFullscreenImage');
            const eventFullscreenText = document.getElementById('eventFullscreenText');

            categoryCards.forEach(card => {
                card.addEventListener('mouseenter', () => {
                    let bgImage = card.getAttribute('data-bg');
                    
                    // Normalize background image path
                    if (bgImage && (bgImage.includes('C:\\') || bgImage.includes('C:/') || bgImage.includes('\\') || bgImage.includes('file:///'))) {
                        const filename = bgImage.split(/[/\\]/).pop();
                        const cleanFilename = filename.replace(/^file:\/\/\//, '').split('/').pop();
                        bgImage = `assets/images/${cleanFilename}`;
                    }
                    
                    if (bgImage && !bgImage.startsWith('assets/') && !bgImage.startsWith('http')) {
                        const filename = bgImage.split('/').pop();
                        bgImage = `assets/images/${filename}`;
                    }
                    
                    bgImage = bgImage.replace(/^file:\/\/\//, '').replace(/^C:[/\\]/, '').replace(/^\/C:[/\\]/, '');
                    
                    if (bgImage) {
                        updateBackground(bgImage);
                    }
                    categoryCards.forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    
                    const cardTitle = card.getAttribute('data-title') || '';
                    const eventHeroTitle = document.getElementById('eventHeroTitle');
                    if (eventHeroTitle && cardTitle) {
                        eventHeroTitle.style.transition = 'opacity 0.3s ease';
                        eventHeroTitle.style.opacity = '0';
                        setTimeout(() => {
                            eventHeroTitle.textContent = cardTitle.toUpperCase();
                            eventHeroTitle.style.opacity = '1';
                        }, 200);
                    }
                });
                
                card.addEventListener('mouseleave', () => {
                    const eventHeroTitle = document.getElementById('eventHeroTitle');
                    if (eventHeroTitle) {
                        eventHeroTitle.style.transition = 'opacity 0.3s ease';
                        eventHeroTitle.style.opacity = '0';
                        setTimeout(() => {
                            eventHeroTitle.textContent = 'EVENTS';
                            eventHeroTitle.style.opacity = '1';
                        }, 200);
                    }
                });

                // Click handler untuk fullscreen view
                card.addEventListener('click', () => {
                    const cardTitle = card.getAttribute('data-title') || '';
                    const cardDescription = card.getAttribute('data-description') || '';
                    let cardImage = card.getAttribute('data-image') || card.getAttribute('data-bg') || '';
                    const cardDate = card.getAttribute('data-date') || '';
                    const cardLocation = card.getAttribute('data-location') || '';
                    const cardLink = card.getAttribute('data-link') || '';
                    
                    // Normalize image path for fullscreen view
                    if (cardImage && (cardImage.includes('C:\\') || cardImage.includes('C:/') || cardImage.includes('\\') || cardImage.includes('file:///'))) {
                        const filename = cardImage.split(/[/\\]/).pop();
                        const cleanFilename = filename.replace(/^file:\/\/\//, '').split('/').pop();
                        cardImage = `assets/images/${cleanFilename}`;
                    }
                    
                    if (!cardImage.startsWith('assets/') && !cardImage.startsWith('http') && cardImage) {
                        const filename = cardImage.split('/').pop();
                        cardImage = `assets/images/${filename}`;
                    }
                    
                    cardImage = cardImage.replace(/^file:\/\/\//, '').replace(/^C:[/\\]/, '').replace(/^\/C:[/\\]/, '');
                    
                    // Use default if no image
                    if (!cardImage || cardImage === '') {
                        cardImage = 'assets/images/02.jpeg';
                    }
                    
                    eventHeroSection.classList.add('moved-to-side');
                    eventCategoriesSection.classList.add('moved-down');
                    
                    // Escape HTML for security
                    const safeTitle = cardTitle.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const safeDescription = cardDescription.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const safeLocation = cardLocation.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    
                    eventFullscreenImage.innerHTML = `<img src="${cardImage}" alt="${safeTitle}" onerror="console.error('Failed to load fullscreen image:', '${cardImage}'); this.src='assets/images/02.jpeg';" loading="lazy">`;
                    eventFullscreenText.innerHTML = `
                        <h2 class="event-fullscreen-title">${safeTitle}</h2>
                        ${cardDate ? `<p class="event-fullscreen-date">üìÖ ${new Date(cardDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>` : ''}
                        ${cardLocation ? `<p class="event-fullscreen-location">üìç ${safeLocation}</p>` : ''}
                        <div class="event-fullscreen-description">${safeDescription}</div>
                        ${cardLink ? `<a href="${cardLink}" class="event-fullscreen-link" target="_blank">Learn More ‚Üí</a>` : ''}
                    `;
                    eventFullscreenView.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
            });

            // Close fullscreen view
            if (eventCloseBtn) {
                eventCloseBtn.addEventListener('click', () => {
                    eventFullscreenView.classList.remove('active');
                    eventHeroSection.classList.remove('moved-to-side');
                    eventCategoriesSection.classList.remove('moved-down');
                    document.body.style.overflow = '';
                });
            }

            // Close on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && eventFullscreenView.classList.contains('active')) {
                    eventFullscreenView.classList.remove('active');
                    eventHeroSection.classList.remove('moved-to-side');
                    eventCategoriesSection.classList.remove('moved-down');
                    document.body.style.overflow = '';
                }
            });
        }
        
        // Load and display events
        async function loadEvents() {
            const eventsGrid = document.getElementById('eventsGrid');
            
            try {
                const eventsRef = collection(db, 'events');
                
                let querySnapshot;
                try {
                    const q = query(eventsRef, orderBy('date', 'asc'));
                    querySnapshot = await getDocs(q);
                } catch (orderError) {
                    console.warn('OrderBy failed, trying without order:', orderError);
                    querySnapshot = await getDocs(eventsRef);
                }

                if (querySnapshot.size === 0) {
                    eventsGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No upcoming events. Stay tuned for our upcoming events and exhibitions.</div>';
                    return;
                }

                const events = [];
                querySnapshot.forEach((docItem) => {
                    events.push({ id: docItem.id, data: docItem.data() });
                });
                
                events.sort((a, b) => {
                    const dateA = a.data.date || '';
                    const dateB = b.data.date || '';
                    return dateA.localeCompare(dateB);
                });

                renderEventCards(events);
            } catch (error) {
                console.error('Error loading events:', error);
                eventsGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #e60505;">Error loading events. Please refresh the page or try again later.</div>';
            }
        }

        // Load events when page loads
        loadEvents();
    </script>

</body>
</html>

